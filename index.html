<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SisLoja - Sistema de Controle de Loja Básico</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/barcodes/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.9/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --gray-color: #7f8c8d;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Menu Lateral */
        .sidebar {
            width: 250px;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            transition: width 0.3s ease;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .sidebar.collapsed {
            width: 70px;
        }

        .logo {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .logo.collapsed h1 {
            display: none;
        }

        .logo i {
            font-size: 1.8rem;
            margin-right: 10px;
        }

        .logo.collapsed i {
            margin-right: 0;
        }

        .menu {
            flex-grow: 1;
            padding: 20px 0;
        }

        .menu-item {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .menu-item.active {
            background-color: rgba(52, 152, 219, 0.2);
            border-left-color: var(--secondary-color);
        }

        .menu-item i {
            width: 30px;
            font-size: 1.2rem;
        }

        .menu-item span {
            transition: opacity 0.3s;
        }

        .sidebar.collapsed .menu-item span {
            opacity: 0;
            width: 0;
            overflow: hidden;
        }

        .toggle-sidebar {
            padding: 15px;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        /* Conteúdo Principal */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background-color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification {
            position: relative;
            cursor: pointer;
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .content {
            padding: 30px;
            flex-grow: 1;
            overflow-y: auto;
        }

        /* Cards e Painéis */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Botões */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-success {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-success:hover {
            background-color: #27ae60;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background-color: #e67e22;
        }

        /* Formulários */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        /* Tabelas */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background-color: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background-color: #f9f9f9;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: color 0.2s;
        }

        .edit-btn {
            color: var(--secondary-color);
        }

        .delete-btn {
            color: var(--danger-color);
        }

        /* Módulo Vendas - PDV */
        .pdv-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .products-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .cart-total {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            text-align: right;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        /* Código de Barras */
        .barcode-container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
        }

        /* Dashboard */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .dashboard-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .card-label {
            color: var(--gray-color);
            font-size: 0.9rem;
        }

        /* Responsividade */
        @media (max-width: 992px) {
            .pdv-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: fixed;
                height: 100vh;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar.collapsed {
                width: 250px;
            }
            
            .sidebar.collapsed .menu-item span {
                opacity: 1;
                width: auto;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Impressão */
        @media print {
            .sidebar, .topbar, .no-print {
                display: none !important;
            }
            
            .content {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* Utilitários */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .text-success {
            color: var(--accent-color);
        }

        .text-danger {
            color: var(--danger-color);
        }

        .text-warning {
            color: var(--warning-color);
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        /* Loader */
        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alertas */
        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .close-alert {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: inherit;
        }
    </style>
</head>
<body>
    <!-- Menu Lateral -->
    <div class="sidebar" id="sidebar">
        <div class="logo" id="logo">
            <i class="fas fa-store"></i>
            <h1>SisLoja</h1>
        </div>
        
        <div class="menu">
            <div class="menu-item active" data-module="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            <div class="menu-item" data-module="produtos">
                <i class="fas fa-boxes"></i>
                <span>Produtos</span>
            </div>
            <div class="menu-item" data-module="vendas">
                <i class="fas fa-cash-register"></i>
                <span>Vendas</span>
            </div>
            <div class="menu-item" data-module="clientes">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </div>
            <div class="menu-item" data-module="relatorios">
                <i class="fas fa-chart-bar"></i>
                <span>Relatórios</span>
            </div>
            <div class="menu-item" data-module="codigos">
                <i class="fas fa-barcode"></i>
                <span>Códigos de Barras</span>
            </div>
            <div class="menu-item" data-module="configuracoes">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </div>
        </div>
        
        <div class="toggle-sidebar" id="toggle-sidebar">
            <i class="fas fa-chevron-left"></i>
        </div>
    </div>
    
    <!-- Conteúdo Principal -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="mobile-menu-btn no-print" id="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
            
            <div class="page-title" id="page-title">Dashboard</div>
            
            <div class="user-info">
                <div class="notification">
                    <i class="fas fa-bell"></i>
                    <div class="badge" id="notification-badge">3</div>
                </div>
                <div>
                    <i class="fas fa-user-circle" style="font-size: 1.5rem;"></i>
                    <span>Administrador</span>
                </div>
            </div>
        </div>
        
        <!-- Conteúdo Dinâmico -->
        <div class="content" id="content">
            <!-- Dashboard -->
            <div id="dashboard-module" class="module">
                <div class="dashboard-cards">
                    <div class="dashboard-card">
                        <i class="fas fa-boxes text-warning"></i>
                        <div class="card-value" id="total-produtos">0</div>
                        <div class="card-label">Produtos Cadastrados</div>
                    </div>
                    <div class="dashboard-card">
                        <i class="fas fa-cash-register text-success"></i>
                        <div class="card-value" id="total-vendas">0</div>
                        <div class="card-label">Vendas Hoje</div>
                    </div>
                    <div class="dashboard-card">
                        <i class="fas fa-exclamation-triangle text-danger"></i>
                        <div class="card-value" id="produtos-baixo">0</div>
                        <div class="card-label">Estoque Baixo</div>
                    </div>
                    <div class="dashboard-card">
                        <i class="fas fa-users text-primary"></i>
                        <div class="card-value" id="total-clientes">0</div>
                        <div class="card-label">Clientes Cadastrados</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Vendas Recentes</h2>
                        <button class="btn btn-primary" id="btn-nova-venda">
                            <i class="fas fa-plus"></i> Nova Venda
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="vendas-recentes">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data</th>
                                    <th>Cliente</th>
                                    <th>Itens</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Produtos com Estoque Baixo</h2>
                    </div>
                    <div class="table-container">
                        <table id="estoque-baixo">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Produto</th>
                                    <th>Estoque Atual</th>
                                    <th>Estoque Mínimo</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Módulo Produtos -->
            <div id="produtos-module" class="module hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Produtos</h2>
                        <div>
                            <button class="btn btn-primary" id="btn-novo-produto">
                                <i class="fas fa-plus"></i> Novo Produto
                            </button>
                            <button class="btn btn-success" id="btn-exportar-produtos">
                                <i class="fas fa-file-export"></i> Exportar
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="busca-produto">Buscar Produto</label>
                            <input type="text" id="busca-produto" placeholder="Digite nome, código ou categoria...">
                        </div>
                        <div class="form-group">
                            <label for="filtro-categoria">Categoria</label>
                            <select id="filtro-categoria">
                                <option value="">Todas</option>
                                <option value="Alimentos">Alimentos</option>
                                <option value="Bebidas">Bebidas</option>
                                <option value="Limpeza">Limpeza</option>
                                <option value="Higiene">Higiene</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table id="tabela-produtos">
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Nome</th>
                                    <th>Categoria</th>
                                    <th>Preço Venda</th>
                                    <th>Estoque</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Módulo Vendas -->
            <div id="vendas-module" class="module hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Ponto de Venda (PDV)</h2>
                        <div class="no-print">
                            <button class="btn btn-success" id="btn-finalizar-venda">
                                <i class="fas fa-check-circle"></i> Finalizar Venda
                            </button>
                            <button class="btn btn-danger" id="btn-cancelar-venda">
                                <i class="fas fa-times-circle"></i> Cancelar
                            </button>
                        </div>
                    </div>
                    
                    <div class="pdv-container">
                        <div>
                            <div class="form-group">
                                <label for="codigo-barras-input">Leitor de Código de Barras</label>
                                <input type="text" id="codigo-barras-input" placeholder="Passe o código de barras ou digite o código do produto" autofocus>
                            </div>
                            
                            <div class="card mb-20">
                                <div class="card-header">
                                    <h3 class="card-title">Produtos no Carrinho</h3>
                                </div>
                                <div class="products-list" id="carrinho-venda">
                                    <!-- Carrinho será preenchido dinamicamente -->
                                    <div class="text-center mt-20" id="carrinho-vazio">
                                        <p>Nenhum produto adicionado ao carrinho.</p>
                                        <p class="text-warning">Passe o código de barras ou digite o código do produto para adicionar.</p>
                                    </div>
                                </div>
                                <div class="cart-total">
                                    Total: R$ <span id="total-venda">0.00</span>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="forma-pagamento">Forma de Pagamento</label>
                                    <select id="forma-pagamento">
                                        <option value="Dinheiro">Dinheiro</option>
                                        <option value="Cartão de Crédito">Cartão de Crédito</option>
                                        <option value="Cartão de Débito">Cartão de Débito</option>
                                        <option value="PIX">PIX</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="cliente-venda">Cliente (opcional)</label>
                                    <select id="cliente-venda">
                                        <option value="">Consumidor Final</option>
                                        <!-- Clientes serão carregados aqui -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Resumo da Venda</h3>
                                </div>
                                <div class="form-group">
                                    <label for="subtotal">Subtotal</label>
                                    <input type="text" id="subtotal" value="R$ 0.00" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="desconto">Desconto (R$)</label>
                                    <input type="number" id="desconto" min="0" step="0.01" value="0.00">
                                </div>
                                <div class="form-group">
                                    <label for="acrescimo">Acréscimo (R$)</label>
                                    <input type="number" id="acrescimo" min="0" step="0.01" value="0.00">
                                </div>
                                <div class="form-group">
                                    <label for="total-final">Total Final</label>
                                    <input type="text" id="total-final" value="R$ 0.00" readonly>
                                </div>
                                <div class="form-group">
                                    <label for="valor-recebido">Valor Recebido</label>
                                    <input type="number" id="valor-recebido" min="0" step="0.01" value="0.00">
                                </div>
                                <div class="form-group">
                                    <label for="troco">Troco</label>
                                    <input type="text" id="troco" value="R$ 0.00" readonly>
                                </div>
                            </div>
                            
                            <div class="card mt-20">
                                <div class="card-header">
                                    <h3 class="card-title">Produtos Mais Vendidos</h3>
                                </div>
                                <div id="produtos-mais-vendidos">
                                    <!-- Lista será preenchida dinamicamente -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-20">
                    <div class="card-header">
                        <h2 class="card-title">Histórico de Vendas</h2>
                        <div>
                            <input type="date" id="data-inicio" value="">
                            <span> até </span>
                            <input type="date" id="data-fim" value="">
                            <button class="btn btn-primary" id="btn-filtrar-vendas">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="tabela-vendas">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Data/Hora</th>
                                    <th>Cliente</th>
                                    <th>Itens</th>
                                    <th>Total</th>
                                    <th>Pagamento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Módulo Clientes -->
            <div id="clientes-module" class="module hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Clientes</h2>
                        <button class="btn btn-primary" id="btn-novo-cliente">
                            <i class="fas fa-plus"></i> Novo Cliente
                        </button>
                    </div>
                    
                    <div class="form-group">
                        <label for="busca-cliente">Buscar Cliente</label>
                        <input type="text" id="busca-cliente" placeholder="Digite nome, telefone ou email...">
                    </div>
                    
                    <div class="table-container">
                        <table id="tabela-clientes">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Telefone</th>
                                    <th>Email</th>
                                    <th>Total Compras</th>
                                    <th>Última Compra</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Preenchido por JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Módulo Relatórios -->
            <div id="relatorios-module" class="module hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Relatórios</h2>
                        <div>
                            <select id="tipo-relatorio">
                                <option value="vendas">Vendas por Período</option>
                                <option value="produtos">Produtos Mais Vendidos</option>
                                <option value="estoque">Estoque Baixo</option>
                                <option value="faturamento">Faturamento Mensal</option>
                            </select>
                            <button class="btn btn-primary" id="btn-gerar-relatorio">
                                <i class="fas fa-chart-bar"></i> Gerar Relatório
                            </button>
                            <button class="btn btn-success" id="btn-imprimir-relatorio">
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="relatorio-data-inicio">Data Início</label>
                            <input type="date" id="relatorio-data-inicio">
                        </div>
                        <div class="form-group">
                            <label for="relatorio-data-fim">Data Fim</label>
                            <input type="date" id="relatorio-data-fim">
                        </div>
                    </div>
                    
                    <div id="relatorio-container">
                        <canvas id="relatorio-chart"></canvas>
                        <div id="relatorio-tabela" class="table-container mt-20"></div>
                    </div>
                </div>
            </div>
            
            <!-- Módulo Códigos de Barras -->
            <div id="codigos-module" class="module hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Gerar Código de Barras</h2>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="barcode-type">Tipo de Código</label>
                            <select id="barcode-type">
                                <option value="EAN13">EAN-13</option>
                                <option value="CODE128">CODE 128</option>
                                <option value="CODE39">CODE 39</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="barcode-value">Valor do Código</label>
                            <input type="text" id="barcode-value" placeholder="Digite o valor para o código de barras">
                        </div>
                        <div class="form-group">
                            <label for="barcode-text">Texto (opcional)</label>
                            <input type="text" id="barcode-text" placeholder="Texto que aparecerá abaixo do código">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary mb-20" id="btn-gerar-barcode">
                        <i class="fas fa-barcode"></i> Gerar Código de Barras
                    </button>
                    
                    <div class="barcode-container card">
                        <svg id="barcode"></svg>
                        <div id="barcode-text-display" class="mt-20"></div>
                        
                        <div class="mt-20">
                            <button class="btn btn-success" id="btn-imprimir-barcode">
                                <i class="fas fa-print"></i> Imprimir Etiqueta
                            </button>
                            <button class="btn btn-primary" id="btn-salvar-barcode">
                                <i class="fas fa-save"></i> Salvar como Imagem
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-20">
                    <div class="card-header">
                        <h2 class="card-title">Validador de Código de Barras</h2>
                    </div>
                    <div class="form-group">
                        <label for="validar-barcode">Digite um código de barras para validar</label>
                        <input type="text" id="validar-barcode" placeholder="Digite um código EAN-13 para validar">
                    </div>
                    <button class="btn btn-primary" id="btn-validar-barcode">
                        <i class="fas fa-check-circle"></i> Validar
                    </button>
                    <div id="validacao-resultado" class="mt-20"></div>
                </div>
            </div>
            
            <!-- Módulo Configurações -->
            <div id="configuracoes-module" class="module hidden">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Configurações do Sistema</h2>
                    </div>
                    
                    <div class="form-group">
                        <label for="nome-loja">Nome da Loja</label>
                        <input type="text" id="nome-loja" placeholder="Digite o nome da sua loja" value="Minha Loja">
                    </div>
                    
                    <div class="form-group">
                        <label for="estoque-minimo-alerta">Estoque Mínimo para Alerta</label>
                        <input type="number" id="estoque-minimo-alerta" min="1" value="5">
                    </div>
                    
                    <div class="form-group">
                        <label for="imposto-padrao">Imposto Padrão (%)</label>
                        <input type="number" id="imposto-padrao" min="0" max="100" step="0.1" value="0">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="notificacoes-email" checked> Ativar notificações por email
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="backup-automatico" checked> Backup automático diário
                            </label>
                        </div>
                    </div>
                    
                    <div class="card-header mt-20">
                        <h3 class="card-title">Backup e Restauração</h3>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <button class="btn btn-success" id="btn-exportar-dados">
                                <i class="fas fa-file-export"></i> Exportar Dados (JSON)
                            </button>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-warning" id="btn-importar-dados">
                                <i class="fas fa-file-import"></i> Importar Dados
                            </button>
                            <input type="file" id="importar-arquivo" class="hidden" accept=".json">
                        </div>
                        <div class="form-group">
                            <button class="btn btn-danger" id="btn-limpar-dados">
                                <i class="fas fa-trash"></i> Limpar Todos os Dados
                            </button>
                        </div>
                    </div>
                    
                    <div class="alert alert-warning hidden" id="backup-alert">
                        <div>
                            <strong>Atenção!</strong> A limpeza de dados é irreversível. Faça backup antes.
                        </div>
                        <button class="close-alert" id="close-backup-alert">&times;</button>
                    </div>
                </div>
            </div>
            
            <!-- Recibo de Venda (Oculto para impressão) -->
            <div id="recibo-container" class="hidden">
                <div class="card" id="recibo">
                    <div class="text-center">
                        <h2 id="recibo-nome-loja">Minha Loja</h2>
                        <p id="recibo-endereco">Rua Exemplo, 123 - Centro - Cidade/UF</p>
                        <p id="recibo-cnpj">CNPJ: 12.345.678/0001-99</p>
                        <hr>
                        <p><strong>RECIBO DE VENDA</strong></p>
                    </div>
                    
                    <div>
                        <p><strong>Nº Venda:</strong> <span id="recibo-id">0001</span></p>
                        <p><strong>Data:</strong> <span id="recibo-data">01/01/2023 10:30:00</span></p>
                        <p><strong>Cliente:</strong> <span id="recibo-cliente">Consumidor Final</span></p>
                        <p><strong>Vendedor:</strong> <span id="recibo-vendedor">Administrador</span></p>
                        <hr>
                    </div>
                    
                    <table id="recibo-itens">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qtd</th>
                                <th>Valor Unit.</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Itens serão preenchidos dinamicamente -->
                        </tbody>
                    </table>
                    
                    <div class="text-right mt-20">
                        <p><strong>Subtotal:</strong> R$ <span id="recibo-subtotal">0.00</span></p>
                        <p><strong>Desconto:</strong> R$ <span id="recibo-desconto">0.00</span></p>
                        <p><strong>Acréscimo:</strong> R$ <span id="recibo-acrescimo">0.00</span></p>
                        <p><strong>Total:</strong> R$ <span id="recibo-total">0.00</span></p>
                        <p><strong>Forma de Pagamento:</strong> <span id="recibo-pagamento">Dinheiro</span></p>
                        <p><strong>Valor Recebido:</strong> R$ <span id="recibo-recebido">0.00</span></p>
                        <p><strong>Troco:</strong> R$ <span id="recibo-troco">0.00</span></p>
                    </div>
                    
                    <hr>
                    <div class="text-center">
                        <p>Obrigado pela preferência!</p>
                        <p>Volte sempre!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Cadastro/Edição de Produto -->
    <div id="produto-modal" class="modal hidden">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" id="modal-produto-titulo">Novo Produto</h2>
                    <button class="btn btn-danger close-modal">&times;</button>
                </div>
                
                <form id="form-produto">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-codigo">Código</label>
                            <input type="text" id="produto-codigo" required>
                        </div>
                        <div class="form-group">
                            <label for="produto-nome">Nome *</label>
                            <input type="text" id="produto-nome" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="produto-descricao">Descrição</label>
                        <textarea id="produto-descricao" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-categoria">Categoria</label>
                            <select id="produto-categoria">
                                <option value="Alimentos">Alimentos</option>
                                <option value="Bebidas">Bebidas</option>
                                <option value="Limpeza">Limpeza</option>
                                <option value="Higiene">Higiene</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="produto-unidade">Unidade</label>
                            <select id="produto-unidade">
                                <option value="UN">UN (Unidade)</option>
                                <option value="KG">KG (Quilo)</option>
                                <option value="LT">LT (Litro)</option>
                                <option value="PC">PC (Peça)</option>
                                <option value="CX">CX (Caixa)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-preco-custo">Preço de Custo (R$)</label>
                            <input type="number" id="produto-preco-custo" min="0" step="0.01" required>
                        </div>
                        <div class="form-group">
                            <label for="produto-preco-venda">Preço de Venda (R$) *</label>
                            <input type="number" id="produto-preco-venda" min="0" step="0.01" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="produto-estoque">Quantidade em Estoque *</label>
                            <input type="number" id="produto-estoque" min="0" step="1" required>
                        </div>
                        <div class="form-group">
                            <label for="produto-estoque-minimo">Estoque Mínimo</label>
                            <input type="number" id="produto-estoque-minimo" min="0" step="1" value="5">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="produto-codigo-barras">Código de Barras</label>
                        <div class="form-row">
                            <input type="text" id="produto-codigo-barras" style="flex: 1;">
                            <button type="button" class="btn btn-primary" id="btn-gerar-codigo">
                                Gerar
                            </button>
                        </div>
                        <div id="produto-barcode-preview" class="mt-10"></div>
                    </div>
                    
                    <div class="text-right mt-20">
                        <button type="button" class="btn btn-danger close-modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar Produto</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal para Cadastro/Edição de Cliente -->
    <div id="cliente-modal" class="modal hidden">
        <div class="modal-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" id="modal-cliente-titulo">Novo Cliente</h2>
                    <button class="btn btn-danger close-modal">&times;</button>
                </div>
                
                <form id="form-cliente">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente-nome">Nome *</label>
                            <input type="text" id="cliente-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="cliente-cpf">CPF/CNPJ</label>
                            <input type="text" id="cliente-cpf">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente-telefone">Telefone *</label>
                            <input type="text" id="cliente-telefone" required>
                        </div>
                        <div class="form-group">
                            <label for="cliente-email">Email</label>
                            <input type="email" id="cliente-email">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="cliente-endereco">Endereço</label>
                        <input type="text" id="cliente-endereco">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cliente-cidade">Cidade</label>
                            <input type="text" id="cliente-cidade">
                        </div>
                        <div class="form-group">
                            <label for="cliente-estado">Estado</label>
                            <input type="text" id="cliente-estado" maxlength="2">
                        </div>
                    </div>
                    
                    <div class="text-right mt-20">
                        <button type="button" class="btn btn-danger close-modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar Cliente</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Estilos para Modais -->
    <style>
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close-modal {
            font-size: 1.5rem;
            padding: 5px 15px;
        }
        
        .mt-10 {
            margin-top: 10px;
        }
    </style>

    <script>
        // ==============================================
        // VARIÁVEIS GLOBAIS E INICIALIZAÇÃO
        // ==============================================
        
        // Banco de dados simulado (IndexedDB via localforage)
        const db = {
            produtos: localforage.createInstance({name: 'sisloja', storeName: 'produtos'}),
            clientes: localforage.createInstance({name: 'sisloja', storeName: 'clientes'}),
            vendas: localforage.createInstance({name: 'sisloja', storeName: 'vendas'}),
            config: localforage.createInstance({name: 'sisloja', storeName: 'config'})
        };
        
        // Estado da aplicação
        const state = {
            moduloAtual: 'dashboard',
            produtoEditando: null,
            clienteEditando: null,
            carrinhoVenda: [],
            ultimoCodigoLido: '',
            config: {
                nomeLoja: 'Minha Loja',
                estoqueMinimoAlerta: 5,
                impostoPadrao: 0
            }
        };
        
        // ==============================================
        // FUNÇÕES DE INICIALIZAÇÃO
        // ==============================================
        
        // Inicialização da aplicação
        document.addEventListener('DOMContentLoaded', async () => {
            await inicializarDados();
            inicializarEventos();
            carregarDashboard();
            atualizarNotificacoes();
            
            // Configurar data atual nos campos de data
            const hoje = dayjs().format('YYYY-MM-DD');
            document.getElementById('data-inicio').value = hoje;
            document.getElementById('data-fim').value = hoje;
            document.getElementById('relatorio-data-inicio').value = hoje;
            document.getElementById('relatorio-data-fim').value = hoje;
        });
        
        // Inicializar dados de exemplo
        async function inicializarDados() {
            try {
                // Carregar configurações
                const configSalva = await db.config.getItem('configuracoes');
                if (configSalva) {
                    state.config = { ...state.config, ...configSalva };
                    aplicarConfiguracoes();
                }
                
                // Verificar se já existem dados
                const produtos = await db.produtos.length();
                const clientes = await db.clientes.length();
                
                // Se não houver dados, criar exemplos
                if (produtos === 0) {
                    await criarProdutosExemplo();
                }
                
                if (clientes === 0) {
                    await criarClientesExemplo();
                }
                
                console.log('Sistema inicializado com sucesso!');
            } catch (error) {
                console.error('Erro ao inicializar dados:', error);
                mostrarAlerta('Erro ao carregar dados do sistema. Recarregue a página.', 'danger');
            }
        }
        
        // Aplicar configurações na interface
        function aplicarConfiguracoes() {
            document.getElementById('nome-loja').value = state.config.nomeLoja;
            document.getElementById('estoque-minimo-alerta').value = state.config.estoqueMinimoAlerta;
            document.getElementById('imposto-padrao').value = state.config.impostoPadrao;
        }
        
        // Criar produtos de exemplo
        async function criarProdutosExemplo() {
            const produtosExemplo = [
                {
                    id: 'P001',
                    codigo: 'P001',
                    nome: 'Arroz 5kg',
                    descricao: 'Arroz branco tipo 1',
                    categoria: 'Alimentos',
                    unidade: 'UN',
                    precoCusto: 15.00,
                    precoVenda: 22.90,
                    estoque: 50,
                    estoqueMinimo: 10,
                    codigoBarras: '7891000050012',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P002',
                    codigo: 'P002',
                    nome: 'Feijão Carioca 1kg',
                    descricao: 'Feijão carioca tipo 1',
                    categoria: 'Alimentos',
                    unidade: 'UN',
                    precoCusto: 6.50,
                    precoVenda: 8.90,
                    estoque: 30,
                    estoqueMinimo: 15,
                    codigoBarras: '7891000050029',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P003',
                    codigo: 'P003',
                    nome: 'Óleo de Soja 900ml',
                    descricao: 'Óleo de soja refinado',
                    categoria: 'Alimentos',
                    unidade: 'UN',
                    precoCusto: 4.80,
                    precoVenda: 6.50,
                    estoque: 20,
                    estoqueMinimo: 10,
                    codigoBarras: '7891000050036',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P004',
                    codigo: 'P004',
                    nome: 'Sabão em Pó 1kg',
                    descricao: 'Sabão em pó para roupas',
                    categoria: 'Limpeza',
                    unidade: 'UN',
                    precoCusto: 7.90,
                    precoVenda: 12.50,
                    estoque: 8,
                    estoqueMinimo: 10,
                    codigoBarras: '7891000050043',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P005',
                    codigo: 'P005',
                    nome: 'Detergente 500ml',
                    descricao: 'Detergente líquido neutro',
                    categoria: 'Limpeza',
                    unidade: 'UN',
                    precoCusto: 1.80,
                    precoVenda: 3.20,
                    estoque: 25,
                    estoqueMinimo: 15,
                    codigoBarras: '7891000050050',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P006',
                    codigo: 'P006',
                    nome: 'Coca-Cola 2L',
                    descricao: 'Refrigerante Coca-Cola',
                    categoria: 'Bebidas',
                    unidade: 'UN',
                    precoCusto: 5.50,
                    precoVenda: 8.90,
                    estoque: 40,
                    estoqueMinimo: 20,
                    codigoBarras: '7891000050067',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P007',
                    codigo: 'P007',
                    nome: 'Pão Francês',
                    descricao: 'Pão francês fresco',
                    categoria: 'Alimentos',
                    unidade: 'UN',
                    precoCusto: 0.40,
                    precoVenda: 0.80,
                    estoque: 200,
                    estoqueMinimo: 100,
                    codigoBarras: '7891000050074',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P008',
                    codigo: 'P008',
                    nome: 'Leite Integral 1L',
                    descricao: 'Leite integral UHT',
                    categoria: 'Alimentos',
                    unidade: 'UN',
                    precoCusto: 3.20,
                    precoVenda: 4.80,
                    estoque: 35,
                    estoqueMinimo: 20,
                    codigoBarras: '7891000050081',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P009',
                    codigo: 'P009',
                    nome: 'Café 500g',
                    descricao: 'Café torrado e moído',
                    categoria: 'Alimentos',
                    unidade: 'UN',
                    precoCusto: 8.90,
                    precoVenda: 14.50,
                    estoque: 15,
                    estoqueMinimo: 10,
                    codigoBarras: '7891000050098',
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'P010',
                    codigo: 'P010',
                    nome: 'Açúcar 5kg',
                    descricao: 'Açúcar refinado',
                    categoria: 'Alimentos',
                    unidade: 'UN',
                    precoCusto: 12.00,
                    precoVenda: 18.90,
                    estoque: 22,
                    estoqueMinimo: 10,
                    codigoBarras: '7891000050104',
                    dataCadastro: dayjs().format()
                }
            ];
            
            for (const produto of produtosExemplo) {
                await db.produtos.setItem(produto.id, produto);
            }
        }
        
        // Criar clientes de exemplo
        async function criarClientesExemplo() {
            const clientesExemplo = [
                {
                    id: 'C001',
                    nome: 'João Silva',
                    cpf: '123.456.789-00',
                    telefone: '(11) 99999-9999',
                    email: 'joao@email.com',
                    endereco: 'Rua das Flores, 123',
                    cidade: 'São Paulo',
                    estado: 'SP',
                    totalCompras: 1250.80,
                    ultimaCompra: dayjs().subtract(2, 'day').format(),
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'C002',
                    nome: 'Maria Santos',
                    cpf: '987.654.321-00',
                    telefone: '(11) 98888-8888',
                    email: 'maria@email.com',
                    endereco: 'Av. Paulista, 1000',
                    cidade: 'São Paulo',
                    estado: 'SP',
                    totalCompras: 890.50,
                    ultimaCompra: dayjs().subtract(5, 'day').format(),
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'C003',
                    nome: 'Pedro Oliveira',
                    cpf: '456.789.123-00',
                    telefone: '(11) 97777-7777',
                    email: 'pedro@email.com',
                    endereco: 'Rua das Palmeiras, 45',
                    cidade: 'São Paulo',
                    estado: 'SP',
                    totalCompras: 1560.20,
                    ultimaCompra: dayjs().subtract(1, 'day').format(),
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'C004',
                    nome: 'Ana Costa',
                    cpf: '789.123.456-00',
                    telefone: '(11) 96666-6666',
                    email: 'ana@email.com',
                    endereco: 'Rua dos Pinheiros, 789',
                    cidade: 'São Paulo',
                    estado: 'SP',
                    totalCompras: 720.30,
                    ultimaCompra: dayjs().subtract(10, 'day').format(),
                    dataCadastro: dayjs().format()
                },
                {
                    id: 'C005',
                    nome: 'Carlos Ferreira',
                    cpf: '321.654.987-00',
                    telefone: '(11) 95555-5555',
                    email: 'carlos@email.com',
                    endereco: 'Av. Brasil, 500',
                    cidade: 'São Paulo',
                    estado: 'SP',
                    totalCompras: 2100.00,
                    ultimaCompra: dayjs().format(),
                    dataCadastro: dayjs().format()
                }
            ];
            
            for (const cliente of clientesExemplo) {
                await db.clientes.setItem(cliente.id, cliente);
            }
        }
        
        // ==============================================
        // FUNÇÕES DE NAVEGAÇÃO E INTERFACE
        // ==============================================
        
        // Inicializar eventos da interface
        function inicializarEventos() {
            // Navegação do menu lateral
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', () => {
                    const modulo = item.getAttribute('data-module');
                    navegarParaModulo(modulo);
                });
            });
            
            // Alternar menu lateral
            document.getElementById('toggle-sidebar').addEventListener('click', toggleSidebar);
            document.getElementById('mobile-menu-btn').addEventListener('click', toggleSidebarMobile);
            
            // Botões do dashboard
            document.getElementById('btn-nova-venda').addEventListener('click', () => navegarParaModulo('vendas'));
            
            // Módulo produtos
            document.getElementById('btn-novo-produto').addEventListener('click', () => abrirModalProduto());
            document.getElementById('btn-exportar-produtos').addEventListener('click', exportarProdutos);
            document.getElementById('busca-produto').addEventListener('input', filtrarProdutos);
            document.getElementById('filtro-categoria').addEventListener('change', filtrarProdutos);
            
            // Módulo vendas
            document.getElementById('codigo-barras-input').addEventListener('keydown', handleCodigoBarras);
            document.getElementById('btn-finalizar-venda').addEventListener('click', finalizarVenda);
            document.getElementById('btn-cancelar-venda').addEventListener('click', cancelarVenda);
            document.getElementById('desconto').addEventListener('input', atualizarTotalVenda);
            document.getElementById('acrescimo').addEventListener('input', atualizarTotalVenda);
            document.getElementById('valor-recebido').addEventListener('input', calcularTroco);
            document.getElementById('btn-filtrar-vendas').addEventListener('click', carregarVendas);
            
            // Módulo clientes
            document.getElementById('btn-novo-cliente').addEventListener('click', () => abrirModalCliente());
            document.getElementById('busca-cliente').addEventListener('input', filtrarClientes);
            
            // Módulo relatórios
            document.getElementById('btn-gerar-relatorio').addEventListener('click', gerarRelatorio);
            document.getElementById('btn-imprimir-relatorio').addEventListener('click', imprimirRelatorio);
            
            // Módulo códigos de barras
            document.getElementById('btn-gerar-barcode').addEventListener('click', gerarCodigoBarras);
            document.getElementById('btn-validar-barcode').addEventListener('click', validarCodigoBarras);
            document.getElementById('btn-imprimir-barcode').addEventListener('click', imprimirCodigoBarras);
            document.getElementById('btn-salvar-barcode').addEventListener('click', salvarCodigoBarras);
            
            // Módulo configurações
            document.getElementById('btn-exportar-dados').addEventListener('click', exportarTodosDados);
            document.getElementById('btn-importar-dados').addEventListener('click', () => document.getElementById('importar-arquivo').click());
            document.getElementById('importar-arquivo').addEventListener('change', importarDados);
            document.getElementById('btn-limpar-dados').addEventListener('click', limparDados);
            document.getElementById('close-backup-alert').addEventListener('click', () => {
                document.getElementById('backup-alert').classList.add('hidden');
            });
            
            // Salvar configurações
            document.getElementById('nome-loja').addEventListener('change', salvarConfiguracao);
            document.getElementById('estoque-minimo-alerta').addEventListener('change', salvarConfiguracao);
            document.getElementById('imposto-padrao').addEventListener('change', salvarConfiguracao);
            
            // Modais
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', fecharModal);
            });
            
            // Formulário produto
            document.getElementById('form-produto').addEventListener('submit', salvarProduto);
            document.getElementById('btn-gerar-codigo').addEventListener('click', gerarCodigoProduto);
            
            // Formulário cliente
            document.getElementById('form-cliente').addEventListener('submit', salvarCliente);
            
            // Fechar modais ao clicar fora
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        fecharModal();
                    }
                });
            });
            
            // Focar no campo de código de barras ao entrar no módulo de vendas
            document.addEventListener('moduloCarregado', (e) => {
                if (e.detail.modulo === 'vendas') {
                    document.getElementById('codigo-barras-input').focus();
                }
            });
        }
        
        // Navegar para um módulo específico
        function navegarParaModulo(modulo) {
            // Atualizar estado
            state.moduloAtual = modulo;
            
            // Atualizar menu
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-module') === modulo) {
                    item.classList.add('active');
                }
            });
            
            // Atualizar título
            const titulos = {
                'dashboard': 'Dashboard',
                'produtos': 'Produtos',
                'vendas': 'Vendas',
                'clientes': 'Clientes',
                'relatorios': 'Relatórios',
                'codigos': 'Códigos de Barras',
                'configuracoes': 'Configurações'
            };
            document.getElementById('page-title').textContent = titulos[modulo] || 'SisLoja';
            
            // Mostrar módulo correto
            document.querySelectorAll('.module').forEach(mod => {
                mod.classList.add('hidden');
            });
            document.getElementById(`${modulo}-module`).classList.remove('hidden');
            
            // Carregar dados específicos do módulo
            switch (modulo) {
                case 'dashboard':
                    carregarDashboard();
                    break;
                case 'produtos':
                    carregarProdutos();
                    break;
                case 'vendas':
                    carregarClientesParaVenda();
                    carregarVendas();
                    carregarProdutosMaisVendidos();
                    break;
                case 'clientes':
                    carregarClientes();
                    break;
                case 'relatorios':
                    gerarRelatorio();
                    break;
            }
            
            // Disparar evento
            document.dispatchEvent(new CustomEvent('moduloCarregado', { detail: { modulo } }));
        }
        
        // Alternar menu lateral (desktop)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const logo = document.getElementById('logo');
            const icon = document.querySelector('#toggle-sidebar i');
            
            sidebar.classList.toggle('collapsed');
            logo.classList.toggle('collapsed');
            
            if (sidebar.classList.contains('collapsed')) {
                icon.className = 'fas fa-chevron-right';
            } else {
                icon.className = 'fas fa-chevron-left';
            }
        }
        
        // Alternar menu lateral (mobile)
        function toggleSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
        }
        
        // ==============================================
        // FUNÇÕES DO DASHBOARD
        // ==============================================
        
        // Carregar dados do dashboard
        async function carregarDashboard() {
            try {
                // Contar produtos
                const produtos = await db.produtos.keys();
                document.getElementById('total-produtos').textContent = produtos.length;
                
                // Contar clientes
                const clientes = await db.clientes.keys();
                document.getElementById('total-clientes').textContent = clientes.length;
                
                // Contar vendas de hoje
                const hoje = dayjs().format('YYYY-MM-DD');
                const vendasHoje = await db.vendas.keys();
                let countVendasHoje = 0;
                
                for (const key of vendasHoje) {
                    const venda = await db.vendas.getItem(key);
                    if (venda && dayjs(venda.data).format('YYYY-MM-DD') === hoje) {
                        countVendasHoje++;
                    }
                }
                document.getElementById('total-vendas').textContent = countVendasHoje;
                
                // Contar produtos com estoque baixo
                let countEstoqueBaixo = 0;
                const produtosEstoqueBaixo = [];
                
                for (const key of produtos) {
                    const produto = await db.produtos.getItem(key);
                    if (produto && produto.estoque <= produto.estoqueMinimo) {
                        countEstoqueBaixo++;
                        produtosEstoqueBaixo.push(produto);
                    }
                }
                document.getElementById('produtos-baixo').textContent = countEstoqueBaixo;
                
                // Carregar vendas recentes
                await carregarVendasRecentes();
                
                // Carregar produtos com estoque baixo
                await carregarProdutosEstoqueBaixo(produtosEstoqueBaixo);
                
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }
        
        // Carregar vendas recentes
        async function carregarVendasRecentes() {
            try {
                const tbody = document.querySelector('#vendas-recentes tbody');
                tbody.innerHTML = '';
                
                const vendas = await db.vendas.keys();
                const vendasRecentes = [];
                
                // Obter últimas 5 vendas
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda) {
                        vendasRecentes.push(venda);
                    }
                }
                
                // Ordenar por data (mais recente primeiro)
                vendasRecentes.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Exibir apenas as 5 mais recentes
                const limite = Math.min(vendasRecentes.length, 5);
                
                for (let i = 0; i < limite; i++) {
                    const venda = vendasRecentes[i];
                    const cliente = venda.clienteId ? await db.clientes.getItem(venda.clienteId) : null;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${venda.id}</td>
                        <td>${dayjs(venda.data).format('DD/MM/YYYY HH:mm')}</td>
                        <td>${cliente ? cliente.nome : 'Consumidor Final'}</td>
                        <td>${venda.itens.length} itens</td>
                        <td>R$ ${venda.total.toFixed(2)}</td>
                        <td><span class="text-success">Finalizada</span></td>
                    `;
                    tbody.appendChild(tr);
                }
                
                if (limite === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="6" class="text-center">Nenhuma venda registrada ainda.</td>`;
                    tbody.appendChild(tr);
                }
                
            } catch (error) {
                console.error('Erro ao carregar vendas recentes:', error);
            }
        }
        
        // Carregar produtos com estoque baixo
        async function carregarProdutosEstoqueBaixo(produtosEstoqueBaixo) {
            try {
                const tbody = document.querySelector('#estoque-baixo tbody');
                tbody.innerHTML = '';
                
                if (produtosEstoqueBaixo.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="5" class="text-center">Nenhum produto com estoque baixo.</td>`;
                    tbody.appendChild(tr);
                    return;
                }
                
                // Ordenar por quantidade (menor primeiro)
                produtosEstoqueBaixo.sort((a, b) => a.estoque - b.estoque);
                
                // Exibir todos
                for (const produto of produtosEstoqueBaixo) {
                    const status = produto.estoque === 0 ? 
                        '<span class="text-danger">ESGOTADO</span>' : 
                        '<span class="text-warning">BAIXO</span>';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${produto.codigo}</td>
                        <td>${produto.nome}</td>
                        <td>${produto.estoque} ${produto.unidade}</td>
                        <td>${produto.estoqueMinimo} ${produto.unidade}</td>
                        <td>${status}</td>
                    `;
                    tbody.appendChild(tr);
                }
                
            } catch (error) {
                console.error('Erro ao carregar produtos com estoque baixo:', error);
            }
        }
        
        // Atualizar notificações
        async function atualizarNotificacoes() {
            try {
                // Contar produtos com estoque baixo
                const produtos = await db.produtos.keys();
                let countEstoqueBaixo = 0;
                
                for (const key of produtos) {
                    const produto = await db.produtos.getItem(key);
                    if (produto && produto.estoque <= produto.estoqueMinimo) {
                        countEstoqueBaixo++;
                    }
                }
                
                // Atualizar badge
                const badge = document.getElementById('notification-badge');
                if (countEstoqueBaixo > 0) {
                    badge.textContent = countEstoqueBaixo;
                    badge.style.display = 'flex';
                } else {
                    badge.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Erro ao atualizar notificações:', error);
            }
        }
        
        // ==============================================
        // FUNÇÕES DO MÓDULO PRODUTOS
        // ==============================================
        
        // Carregar produtos na tabela
        async function carregarProdutos() {
            try {
                const tbody = document.querySelector('#tabela-produtos tbody');
                tbody.innerHTML = '';
                
                const produtos = await db.produtos.keys();
                const produtosArray = [];
                
                for (const key of produtos) {
                    const produto = await db.produtos.getItem(key);
                    if (produto) {
                        produtosArray.push(produto);
                    }
                }
                
                // Ordenar por nome
                produtosArray.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Exibir todos
                for (const produto of produtosArray) {
                    const status = produto.estoque > produto.estoqueMinimo ? 
                        '<span class="text-success">OK</span>' :
                        produto.estoque === 0 ? 
                        '<span class="text-danger">ESGOTADO</span>' : 
                        '<span class="text-warning">BAIXO</span>';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${produto.codigo}</td>
                        <td>${produto.nome}</td>
                        <td>${produto.categoria}</td>
                        <td>R$ ${produto.precoVenda.toFixed(2)}</td>
                        <td>${produto.estoque} ${produto.unidade}</td>
                        <td>${status}</td>
                        <td class="actions">
                            <button class="action-btn edit-btn" data-id="${produto.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${produto.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                
                // Adicionar eventos aos botões
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        abrirModalProduto(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        excluirProduto(id);
                    });
                });
                
                // Se não houver produtos
                if (produtosArray.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="7" class="text-center">Nenhum produto cadastrado.</td>`;
                    tbody.appendChild(tr);
                }
                
            } catch (error) {
                console.error('Erro ao carregar produtos:', error);
                mostrarAlerta('Erro ao carregar produtos. Tente novamente.', 'danger');
            }
        }
        
        // Filtrar produtos
        async function filtrarProdutos() {
            try {
                const busca = document.getElementById('busca-produto').value.toLowerCase();
                const categoria = document.getElementById('filtro-categoria').value;
                
                const tbody = document.querySelector('#tabela-produtos tbody');
                tbody.innerHTML = '';
                
                const produtos = await db.produtos.keys();
                const produtosArray = [];
                
                for (const key of produtos) {
                    const produto = await db.produtos.getItem(key);
                    if (produto) {
                        produtosArray.push(produto);
                    }
                }
                
                // Aplicar filtros
                let produtosFiltrados = produtosArray;
                
                if (busca) {
                    produtosFiltrados = produtosFiltrados.filter(p => 
                        p.nome.toLowerCase().includes(busca) || 
                        p.codigo.toLowerCase().includes(busca) ||
                        p.categoria.toLowerCase().includes(busca) ||
                        (p.descricao && p.descricao.toLowerCase().includes(busca))
                    );
                }
                
                if (categoria) {
                    produtosFiltrados = produtosFiltrados.filter(p => p.categoria === categoria);
                }
                
                // Ordenar por nome
                produtosFiltrados.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Exibir resultados filtrados
                for (const produto of produtosFiltrados) {
                    const status = produto.estoque > produto.estoqueMinimo ? 
                        '<span class="text-success">OK</span>' :
                        produto.estoque === 0 ? 
                        '<span class="text-danger">ESGOTADO</span>' : 
                        '<span class="text-warning">BAIXO</span>';
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${produto.codigo}</td>
                        <td>${produto.nome}</td>
                        <td>${produto.categoria}</td>
                        <td>R$ ${produto.precoVenda.toFixed(2)}</td>
                        <td>${produto.estoque} ${produto.unidade}</td>
                        <td>${status}</td>
                        <td class="actions">
                            <button class="action-btn edit-btn" data-id="${produto.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${produto.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                
                // Adicionar eventos aos botões
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        abrirModalProduto(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        excluirProduto(id);
                    });
                });
                
                // Se não houver produtos após filtrar
                if (produtosFiltrados.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="7" class="text-center">Nenhum produto encontrado.</td>`;
                    tbody.appendChild(tr);
                }
                
            } catch (error) {
                console.error('Erro ao filtrar produtos:', error);
            }
        }
        
        // Abrir modal para cadastro/edição de produto
        async function abrirModalProduto(id = null) {
            const modal = document.getElementById('produto-modal');
            const titulo = document.getElementById('modal-produto-titulo');
            const form = document.getElementById('form-produto');
            
            // Limpar formulário
            form.reset();
            
            if (id) {
                // Modo edição
                titulo.textContent = 'Editar Produto';
                state.produtoEditando = id;
                
                try {
                    const produto = await db.produtos.getItem(id);
                    if (produto) {
                        document.getElementById('produto-codigo').value = produto.codigo;
                        document.getElementById('produto-nome').value = produto.nome;
                        document.getElementById('produto-descricao').value = produto.descricao || '';
                        document.getElementById('produto-categoria').value = produto.categoria;
                        document.getElementById('produto-unidade').value = produto.unidade;
                        document.getElementById('produto-preco-custo').value = produto.precoCusto;
                        document.getElementById('produto-preco-venda').value = produto.precoVenda;
                        document.getElementById('produto-estoque').value = produto.estoque;
                        document.getElementById('produto-estoque-minimo').value = produto.estoqueMinimo;
                        document.getElementById('produto-codigo-barras').value = produto.codigoBarras || '';
                        
                        // Exibir código de barras se existir
                        if (produto.codigoBarras) {
                            const preview = document.getElementById('produto-barcode-preview');
                            preview.innerHTML = '';
                            
                            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            JsBarcode(svg, produto.codigoBarras, {
                                format: 'EAN13',
                                width: 2,
                                height: 50,
                                displayValue: true
                            });
                            preview.appendChild(svg);
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar produto para edição:', error);
                    mostrarAlerta('Erro ao carregar produto para edição.', 'danger');
                    return;
                }
            } else {
                // Modo cadastro
                titulo.textContent = 'Novo Produto';
                state.produtoEditando = null;
                
                // Gerar código automático
                const produtos = await db.produtos.keys();
                const novoCodigo = 'P' + String(produtos.length + 1).padStart(3, '0');
                document.getElementById('produto-codigo').value = novoCodigo;
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
            document.getElementById('produto-nome').focus();
        }
        
        // Gerar código de barras para produto
        function gerarCodigoProduto() {
            const codigo = document.getElementById('produto-codigo').value;
            const tipo = 'EAN13';
            
            if (!codigo) {
                mostrarAlerta('Digite um código para o produto primeiro.', 'warning');
                return;
            }
            
            // Gerar código EAN-13 válido (12 dígitos + dígito verificador)
            let baseCodigo = codigo.replace(/\D/g, ''); // Remove não-dígitos
            if (baseCodigo.length > 12) {
                baseCodigo = baseCodigo.substring(0, 12);
            } else if (baseCodigo.length < 12) {
                // Preencher com zeros à esquerda
                baseCodigo = baseCodigo.padStart(12, '0');
            }
            
            // Calcular dígito verificador para EAN-13
            const digitoVerificador = calcularDigitoVerificadorEAN(baseCodigo);
            const codigoCompleto = baseCodigo + digitoVerificador;
            
            document.getElementById('produto-codigo-barras').value = codigoCompleto;
            
            // Exibir preview
            const preview = document.getElementById('produto-barcode-preview');
            preview.innerHTML = '';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            JsBarcode(svg, codigoCompleto, {
                format: tipo,
                width: 2,
                height: 50,
                displayValue: true
            });
            preview.appendChild(svg);
        }
        
        // Calcular dígito verificador EAN
        function calcularDigitoVerificadorEAN(codigo) {
            let soma = 0;
            for (let i = 0; i < codigo.length; i++) {
                const digito = parseInt(codigo[i]);
                soma += (i % 2 === 0) ? digito : digito * 3;
            }
            const resto = soma % 10;
            return resto === 0 ? 0 : 10 - resto;
        }
        
        // Salvar produto (cadastro ou edição)
        async function salvarProduto(e) {
            e.preventDefault();
            
            try {
                // Coletar dados do formulário
                const produto = {
                    id: state.produtoEditando || document.getElementById('produto-codigo').value,
                    codigo: document.getElementById('produto-codigo').value,
                    nome: document.getElementById('produto-nome').value,
                    descricao: document.getElementById('produto-descricao').value,
                    categoria: document.getElementById('produto-categoria').value,
                    unidade: document.getElementById('produto-unidade').value,
                    precoCusto: parseFloat(document.getElementById('produto-preco-custo').value),
                    precoVenda: parseFloat(document.getElementById('produto-preco-venda').value),
                    estoque: parseInt(document.getElementById('produto-estoque').value),
                    estoqueMinimo: parseInt(document.getElementById('produto-estoque-minimo').value),
                    codigoBarras: document.getElementById('produto-codigo-barras').value || null,
                    dataCadastro: state.produtoEditando ? undefined : dayjs().format(),
                    dataAtualizacao: dayjs().format()
                };
                
                // Validar dados
                if (!produto.codigo || !produto.nome || isNaN(produto.precoVenda) || isNaN(produto.estoque)) {
                    mostrarAlerta('Preencha todos os campos obrigatórios (*).', 'warning');
                    return;
                }
                
                if (produto.precoVenda <= 0) {
                    mostrarAlerta('O preço de venda deve ser maior que zero.', 'warning');
                    return;
                }
                
                if (produto.estoque < 0) {
                    mostrarAlerta('O estoque não pode ser negativo.', 'warning');
                    return;
                }
                
                // Salvar no banco de dados
                await db.produtos.setItem(produto.id, produto);
                
                // Fechar modal e atualizar lista
                fecharModal();
                carregarProdutos();
                atualizarDashboard();
                atualizarNotificacoes();
                
                mostrarAlerta(`Produto "${produto.nome}" salvo com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao salvar produto:', error);
                mostrarAlerta('Erro ao salvar produto. Tente novamente.', 'danger');
            }
        }
        
        // Excluir produto
        async function excluirProduto(id) {
            if (!confirm('Tem certeza que deseja excluir este produto?')) {
                return;
            }
            
            try {
                const produto = await db.produtos.getItem(id);
                if (!produto) {
                    mostrarAlerta('Produto não encontrado.', 'warning');
                    return;
                }
                
                // Verificar se o produto está em alguma venda
                const vendas = await db.vendas.keys();
                let produtoEmVenda = false;
                
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda && venda.itens.some(item => item.produtoId === id)) {
                        produtoEmVenda = true;
                        break;
                    }
                }
                
                if (produtoEmVenda) {
                    mostrarAlerta('Este produto não pode ser excluído porque está em vendas registradas.', 'warning');
                    return;
                }
                
                // Excluir produto
                await db.produtos.removeItem(id);
                
                // Atualizar interface
                carregarProdutos();
                atualizarDashboard();
                
                mostrarAlerta('Produto excluído com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao excluir produto:', error);
                mostrarAlerta('Erro ao excluir produto. Tente novamente.', 'danger');
            }
        }
        
        // Exportar produtos
        async function exportarProdutos() {
            try {
                const produtos = await db.produtos.keys();
                const produtosArray = [];
                
                for (const key of produtos) {
                    const produto = await db.produtos.getItem(key);
                    if (produto) {
                        produtosArray.push(produto);
                    }
                }
                
                const dados = JSON.stringify(produtosArray, null, 2);
                const blob = new Blob([dados], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `produtos_sisloja_${dayjs().format('YYYY-MM-DD')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                
                mostrarAlerta('Produtos exportados com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar produtos:', error);
                mostrarAlerta('Erro ao exportar produtos. Tente novamente.', 'danger');
            }
        }
        
        // ==============================================
        // FUNÇÕES DO MÓDULO VENDAS
        // ==============================================
        
        // Carregar clientes para seleção em vendas
        async function carregarClientesParaVenda() {
            try {
                const select = document.getElementById('cliente-venda');
                select.innerHTML = '<option value="">Consumidor Final</option>';
                
                const clientes = await db.clientes.keys();
                for (const key of clientes) {
                    const cliente = await db.clientes.getItem(key);
                    if (cliente) {
                        const option = document.createElement('option');
                        option.value = cliente.id;
                        option.textContent = cliente.nome;
                        select.appendChild(option);
                    }
                }
                
            } catch (error) {
                console.error('Erro ao carregar clientes para venda:', error);
            }
        }
        
        // Carregar vendas na tabela
        async function carregarVendas() {
            try {
                const dataInicio = document.getElementById('data-inicio').value;
                const dataFim = document.getElementById('data-fim').value;
                
                const tbody = document.querySelector('#tabela-vendas tbody');
                tbody.innerHTML = '';
                
                const vendas = await db.vendas.keys();
                const vendasArray = [];
                
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda) {
                        vendasArray.push(venda);
                    }
                }
                
                // Filtrar por data
                let vendasFiltradas = vendasArray;
                
                if (dataInicio) {
                    const inicio = dayjs(dataInicio).startOf('day');
                    vendasFiltradas = vendasFiltradas.filter(v => dayjs(v.data).isAfter(inicio) || dayjs(v.data).isSame(inicio));
                }
                
                if (dataFim) {
                    const fim = dayjs(dataFim).endOf('day');
                    vendasFiltradas = vendasFiltradas.filter(v => dayjs(v.data).isBefore(fim) || dayjs(v.data).isSame(fim));
                }
                
                // Ordenar por data (mais recente primeiro)
                vendasFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
                
                // Exibir resultados
                for (const venda of vendasFiltradas) {
                    const cliente = venda.clienteId ? await db.clientes.getItem(venda.clienteId) : null;
                    const qtdItens = venda.itens.reduce((total, item) => total + item.quantidade, 0);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${venda.id}</td>
                        <td>${dayjs(venda.data).format('DD/MM/YYYY HH:mm')}</td>
                        <td>${cliente ? cliente.nome : 'Consumidor Final'}</td>
                        <td>${qtdItens} itens</td>
                        <td>R$ ${venda.total.toFixed(2)}</td>
                        <td>${venda.formaPagamento}</td>
                        <td class="actions">
                            <button class="btn btn-primary btn-sm" data-id="${venda.id}" onclick="imprimirRecibo('${venda.id}')">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                
                // Se não houver vendas
                if (vendasFiltradas.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="7" class="text-center">Nenhuma venda encontrada para o período.</td>`;
                    tbody.appendChild(tr);
                }
                
            } catch (error) {
                console.error('Erro ao carregar vendas:', error);
                mostrarAlerta('Erro ao carregar vendas. Tente novamente.', 'danger');
            }
        }
        
        // Carregar produtos mais vendidos
        async function carregarProdutosMaisVendidos() {
            try {
                const container = document.getElementById('produtos-mais-vendidos');
                container.innerHTML = '';
                
                const vendas = await db.vendas.keys();
                const contagemProdutos = {};
                
                // Contar vendas por produto
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda && venda.itens) {
                        for (const item of venda.itens) {
                            if (!contagemProdutos[item.produtoId]) {
                                contagemProdutos[item.produtoId] = {
                                    quantidade: 0,
                                    produto: null
                                };
                            }
                            contagemProdutos[item.produtoId].quantidade += item.quantidade;
                        }
                    }
                }
                
                // Buscar informações dos produtos
                for (const produtoId in contagemProdutos) {
                    const produto = await db.produtos.getItem(produtoId);
                    if (produto) {
                        contagemProdutos[produtoId].produto = produto;
                    }
                }
                
                // Converter para array e ordenar
                const produtosArray = Object.values(contagemProdutos)
                    .filter(item => item.produto)
                    .sort((a, b) => b.quantidade - a.quantidade)
                    .slice(0, 5); // Apenas os 5 mais vendidos
                
                // Exibir
                if (produtosArray.length === 0) {
                    container.innerHTML = '<p class="text-center">Nenhum dado de venda disponível.</p>';
                    return;
                }
                
                for (const item of produtosArray) {
                    const produto = item.produto;
                    const div = document.createElement('div');
                    div.className = 'cart-item';
                    div.innerHTML = `
                        <div>
                            <strong>${produto.nome}</strong><br>
                            <small>${produto.categoria}</small>
                        </div>
                        <div class="text-right">
                            <div>${item.quantidade} vendidos</div>
                            <small>R$ ${produto.precoVenda.toFixed(2)}</small>
                        </div>
                    `;
                    container.appendChild(div);
                }
                
            } catch (error) {
                console.error('Erro ao carregar produtos mais vendidos:', error);
            }
        }
        
        // Manipular entrada de código de barras
        async function handleCodigoBarras(e) {
            // Se for Enter, adicionar produto ao carrinho
            if (e.key === 'Enter') {
                e.preventDefault();
                
                const codigo = document.getElementById('codigo-barras-input').value.trim();
                if (!codigo) return;
                
                await adicionarProdutoAoCarrinho(codigo);
                
                // Limpar campo e focar novamente
                document.getElementById('codigo-barras-input').value = '';
                document.getElementById('codigo-barras-input').focus();
            }
        }
        
        // Adicionar produto ao carrinho de vendas
        async function adicionarProdutoAoCarrinho(codigo) {
            try {
                // Buscar produto pelo código ou código de barras
                let produto = null;
                const produtos = await db.produtos.keys();
                
                for (const key of produtos) {
                    const p = await db.produtos.getItem(key);
                    if (p && (p.codigo === codigo || p.codigoBarras === codigo)) {
                        produto = p;
                        break;
                    }
                }
                
                if (!produto) {
                    mostrarAlerta('Produto não encontrado!', 'warning');
                    return;
                }
                
                // Verificar estoque
                if (produto.estoque <= 0) {
                    mostrarAlerta(`Produto "${produto.nome}" sem estoque!`, 'danger');
                    return;
                }
                
                // Verificar se produto já está no carrinho
                const index = state.carrinhoVenda.findIndex(item => item.produtoId === produto.id);
                
                if (index !== -1) {
                    // Incrementar quantidade
                    state.carrinhoVenda[index].quantidade++;
                } else {
                    // Adicionar novo item
                    state.carrinhoVenda.push({
                        produtoId: produto.id,
                        codigo: produto.codigo,
                        nome: produto.nome,
                        precoUnitario: produto.precoVenda,
                        quantidade: 1,
                        total: produto.precoVenda
                    });
                }
                
                // Atualizar carrinho na tela
                atualizarCarrinhoVenda();
                atualizarTotalVenda();
                
                mostrarAlerta(`Produto "${produto.nome}" adicionado ao carrinho!`, 'success');
                
            } catch (error) {
                console.error('Erro ao adicionar produto ao carrinho:', error);
                mostrarAlerta('Erro ao adicionar produto ao carrinho.', 'danger');
            }
        }
        
        // Atualizar carrinho de vendas na tela
        function atualizarCarrinhoVenda() {
            const container = document.getElementById('carrinho-venda');
            const carrinhoVazio = document.getElementById('carrinho-vazio');
            
            // Esconder mensagem de carrinho vazio
            carrinhoVazio.classList.add('hidden');
            
            // Limpar container
            container.innerHTML = '';
            
            // Adicionar itens
            state.carrinhoVenda.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div>
                        <strong>${item.nome}</strong><br>
                        <small>Código: ${item.codigo}</small>
                    </div>
                    <div class="text-right">
                        <div>
                            <button class="btn btn-sm" onclick="alterarQuantidade(${index}, -1)">-</button>
                            <span style="margin: 0 10px;">${item.quantidade}</span>
                            <button class="btn btn-sm" onclick="alterarQuantidade(${index}, 1)">+</button>
                        </div>
                        <div>R$ ${item.precoUnitario.toFixed(2)}</div>
                        <div><strong>R$ ${(item.precoUnitario * item.quantidade).toFixed(2)}</strong></div>
                        <div>
                            <button class="btn btn-danger btn-sm" onclick="removerItemCarrinho(${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // Se carrinho estiver vazio, mostrar mensagem
            if (state.carrinhoVenda.length === 0) {
                carrinhoVazio.classList.remove('hidden');
            }
        }
        
        // Alterar quantidade de um item no carrinho
        function alterarQuantidade(index, delta) {
            const item = state.carrinhoVenda[index];
            const novaQuantidade = item.quantidade + delta;
            
            if (novaQuantidade < 1) {
                removerItemCarrinho(index);
                return;
            }
            
            state.carrinhoVenda[index].quantidade = novaQuantidade;
            atualizarCarrinhoVenda();
            atualizarTotalVenda();
        }
        
        // Remover item do carrinho
        function removerItemCarrinho(index) {
            state.carrinhoVenda.splice(index, 1);
            atualizarCarrinhoVenda();
            atualizarTotalVenda();
            
            if (state.carrinhoVenda.length === 0) {
                mostrarAlerta('Carrinho limpo.', 'info');
            }
        }
        
        // Atualizar total da venda
        function atualizarTotalVenda() {
            // Calcular subtotal
            const subtotal = state.carrinhoVenda.reduce((total, item) => {
                return total + (item.precoUnitario * item.quantidade);
            }, 0);
            
            // Obter desconto e acréscimo
            const desconto = parseFloat(document.getElementById('desconto').value) || 0;
            const acrescimo = parseFloat(document.getElementById('acrescimo').value) || 0;
            
            // Calcular total final
            const totalFinal = subtotal - desconto + acrescimo;
            
            // Atualizar campos
            document.getElementById('subtotal').value = `R$ ${subtotal.toFixed(2)}`;
            document.getElementById('total-final').value = `R$ ${totalFinal.toFixed(2)}`;
            document.getElementById('total-venda').textContent = totalFinal.toFixed(2);
            
            // Calcular troco se valor recebido for informado
            calcularTroco();
        }
        
        // Calcular troco
        function calcularTroco() {
            const totalFinal = parseFloat(document.getElementById('total-final').value.replace('R$ ', '')) || 0;
            const valorRecebido = parseFloat(document.getElementById('valor-recebido').value) || 0;
            
            const troco = valorRecebido - totalFinal;
            document.getElementById('troco').value = `R$ ${troco > 0 ? troco.toFixed(2) : '0.00'}`;
        }
        
        // Cancelar venda
        function cancelarVenda() {
            if (state.carrinhoVenda.length === 0) {
                mostrarAlerta('Não há venda em andamento.', 'info');
                return;
            }
            
            if (!confirm('Deseja realmente cancelar esta venda?')) {
                return;
            }
            
            state.carrinhoVenda = [];
            document.getElementById('codigo-barras-input').value = '';
            document.getElementById('desconto').value = '0.00';
            document.getElementById('acrescimo').value = '0.00';
            document.getElementById('valor-recebido').value = '0.00';
            
            atualizarCarrinhoVenda();
            atualizarTotalVenda();
            document.getElementById('codigo-barras-input').focus();
            
            mostrarAlerta('Venda cancelada.', 'info');
        }
        
        // Finalizar venda
        async function finalizarVenda() {
            if (state.carrinhoVenda.length === 0) {
                mostrarAlerta('Adicione produtos ao carrinho antes de finalizar a venda.', 'warning');
                return;
            }
            
            // Calcular valores
            const subtotal = state.carrinhoVenda.reduce((total, item) => {
                return total + (item.precoUnitario * item.quantidade);
            }, 0);
            
            const desconto = parseFloat(document.getElementById('desconto').value) || 0;
            const acrescimo = parseFloat(document.getElementById('acrescimo').value) || 0;
            const totalFinal = subtotal - desconto + acrescimo;
            
            const formaPagamento = document.getElementById('forma-pagamento').value;
            const clienteId = document.getElementById('cliente-venda').value;
            const valorRecebido = parseFloat(document.getElementById('valor-recebido').value) || 0;
            
            // Validar pagamento
            if (formaPagamento === 'Dinheiro' && valorRecebido < totalFinal) {
                mostrarAlerta('Valor recebido é menor que o total da venda.', 'warning');
                return;
            }
            
            // Confirmar venda
            if (!confirm(`Confirmar venda no valor de R$ ${totalFinal.toFixed(2)}?`)) {
                return;
            }
            
            try {
                // Gerar ID da venda
                const vendas = await db.vendas.keys();
                const vendaId = 'V' + String(vendas.length + 1).padStart(4, '0');
                
                // Criar objeto da venda
                const venda = {
                    id: vendaId,
                    data: dayjs().format(),
                    clienteId: clienteId || null,
                    itens: state.carrinhoVenda.map(item => ({
                        produtoId: item.produtoId,
                        codigo: item.codigo,
                        nome: item.nome,
                        precoUnitario: item.precoUnitario,
                        quantidade: item.quantidade,
                        total: item.precoUnitario * item.quantidade
                    })),
                    subtotal: subtotal,
                    desconto: desconto,
                    acrescimo: acrescimo,
                    total: totalFinal,
                    formaPagamento: formaPagamento,
                    valorRecebido: valorRecebido,
                    troco: Math.max(0, valorRecebido - totalFinal)
                };
                
                // Salvar venda
                await db.vendas.setItem(vendaId, venda);
                
                // Atualizar estoque dos produtos
                for (const item of state.carrinhoVenda) {
                    const produto = await db.produtos.getItem(item.produtoId);
                    if (produto) {
                        produto.estoque -= item.quantidade;
                        if (produto.estoque < 0) produto.estoque = 0;
                        produto.dataAtualizacao = dayjs().format();
                        await db.produtos.setItem(produto.id, produto);
                    }
                }
                
                // Atualizar cliente (se houver)
                if (clienteId) {
                    const cliente = await db.clientes.getItem(clienteId);
                    if (cliente) {
                        cliente.totalCompras = (cliente.totalCompras || 0) + totalFinal;
                        cliente.ultimaCompra = dayjs().format();
                        await db.clientes.setItem(clienteId, cliente);
                    }
                }
                
                // Limpar carrinho
                state.carrinhoVenda = [];
                
                // Atualizar interface
                atualizarCarrinhoVenda();
                atualizarTotalVenda();
                document.getElementById('desconto').value = '0.00';
                document.getElementById('acrescimo').value = '0.00';
                document.getElementById('valor-recebido').value = '0.00';
                document.getElementById('codigo-barras-input').value = '';
                document.getElementById('codigo-barras-input').focus();
                
                // Atualizar outras partes do sistema
                carregarVendas();
                carregarProdutosMaisVendidos();
                atualizarDashboard();
                atualizarNotificacoes();
                
                // Mostrar recibo
                await imprimirRecibo(vendaId);
                
                mostrarAlerta(`Venda ${vendaId} finalizada com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao finalizar venda:', error);
                mostrarAlerta('Erro ao finalizar venda. Tente novamente.', 'danger');
            }
        }
        
        // ==============================================
        // FUNÇÕES DO MÓDULO CLIENTES
        // ==============================================
        
        // Carregar clientes na tabela
        async function carregarClientes() {
            try {
                const tbody = document.querySelector('#tabela-clientes tbody');
                tbody.innerHTML = '';
                
                const clientes = await db.clientes.keys();
                const clientesArray = [];
                
                for (const key of clientes) {
                    const cliente = await db.clientes.getItem(key);
                    if (cliente) {
                        clientesArray.push(cliente);
                    }
                }
                
                // Ordenar por nome
                clientesArray.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Exibir todos
                for (const cliente of clientesArray) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cliente.id}</td>
                        <td>${cliente.nome}</td>
                        <td>${cliente.telefone}</td>
                        <td>${cliente.email || '-'}</td>
                        <td>R$ ${(cliente.totalCompras || 0).toFixed(2)}</td>
                        <td>${cliente.ultimaCompra ? dayjs(cliente.ultimaCompra).format('DD/MM/YYYY') : '-'}</td>
                        <td class="actions">
                            <button class="action-btn edit-btn" data-id="${cliente.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${cliente.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                
                // Adicionar eventos aos botões
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        abrirModalCliente(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        excluirCliente(id);
                    });
                });
                
                // Se não houver clientes
                if (clientesArray.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="7" class="text-center">Nenhum cliente cadastrado.</td>`;
                    tbody.appendChild(tr);
                }
                
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                mostrarAlerta('Erro ao carregar clientes. Tente novamente.', 'danger');
            }
        }
        
        // Filtrar clientes
        async function filtrarClientes() {
            try {
                const busca = document.getElementById('busca-cliente').value.toLowerCase();
                
                const tbody = document.querySelector('#tabela-clientes tbody');
                tbody.innerHTML = '';
                
                const clientes = await db.clientes.keys();
                const clientesArray = [];
                
                for (const key of clientes) {
                    const cliente = await db.clientes.getItem(key);
                    if (cliente) {
                        clientesArray.push(cliente);
                    }
                }
                
                // Aplicar filtro
                let clientesFiltrados = clientesArray;
                
                if (busca) {
                    clientesFiltrados = clientesFiltrados.filter(c => 
                        c.nome.toLowerCase().includes(busca) || 
                        (c.telefone && c.telefone.includes(busca)) ||
                        (c.email && c.email.toLowerCase().includes(busca)) ||
                        (c.cpf && c.cpf.includes(busca))
                    );
                }
                
                // Ordenar por nome
                clientesFiltrados.sort((a, b) => a.nome.localeCompare(b.nome));
                
                // Exibir resultados filtrados
                for (const cliente of clientesFiltrados) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${cliente.id}</td>
                        <td>${cliente.nome}</td>
                        <td>${cliente.telefone}</td>
                        <td>${cliente.email || '-'}</td>
                        <td>R$ ${(cliente.totalCompras || 0).toFixed(2)}</td>
                        <td>${cliente.ultimaCompra ? dayjs(cliente.ultimaCompra).format('DD/MM/YYYY') : '-'}</td>
                        <td class="actions">
                            <button class="action-btn edit-btn" data-id="${cliente.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete-btn" data-id="${cliente.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                
                // Adicionar eventos aos botões
                document.querySelectorAll('.edit-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        abrirModalCliente(id);
                    });
                });
                
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        excluirCliente(id);
                    });
                });
                
                // Se não houver clientes após filtrar
                if (clientesFiltrados.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td colspan="7" class="text-center">Nenhum cliente encontrado.</td>`;
                    tbody.appendChild(tr);
                }
                
            } catch (error) {
                console.error('Erro ao filtrar clientes:', error);
            }
        }
        
        // Abrir modal para cadastro/edição de cliente
        async function abrirModalCliente(id = null) {
            const modal = document.getElementById('cliente-modal');
            const titulo = document.getElementById('modal-cliente-titulo');
            const form = document.getElementById('form-cliente');
            
            // Limpar formulário
            form.reset();
            
            if (id) {
                // Modo edição
                titulo.textContent = 'Editar Cliente';
                state.clienteEditando = id;
                
                try {
                    const cliente = await db.clientes.getItem(id);
                    if (cliente) {
                        document.getElementById('cliente-nome').value = cliente.nome;
                        document.getElementById('cliente-cpf').value = cliente.cpf || '';
                        document.getElementById('cliente-telefone').value = cliente.telefone;
                        document.getElementById('cliente-email').value = cliente.email || '';
                        document.getElementById('cliente-endereco').value = cliente.endereco || '';
                        document.getElementById('cliente-cidade').value = cliente.cidade || '';
                        document.getElementById('cliente-estado').value = cliente.estado || '';
                    }
                } catch (error) {
                    console.error('Erro ao carregar cliente para edição:', error);
                    mostrarAlerta('Erro ao carregar cliente para edição.', 'danger');
                    return;
                }
            } else {
                // Modo cadastro
                titulo.textContent = 'Novo Cliente';
                state.clienteEditando = null;
                
                // Gerar ID automático
                const clientes = await db.clientes.keys();
                const novoId = 'C' + String(clientes.length + 1).padStart(3, '0');
                // Não preencher o ID visível, apenas usar internamente
            }
            
            // Mostrar modal
            modal.classList.remove('hidden');
            document.getElementById('cliente-nome').focus();
        }
        
        // Salvar cliente (cadastro ou edição)
        async function salvarCliente(e) {
            e.preventDefault();
            
            try {
                // Coletar dados do formulário
                const cliente = {
                    id: state.clienteEditando || `C${Date.now()}`,
                    nome: document.getElementById('cliente-nome').value,
                    cpf: document.getElementById('cliente-cpf').value || null,
                    telefone: document.getElementById('cliente-telefone').value,
                    email: document.getElementById('cliente-email').value || null,
                    endereco: document.getElementById('cliente-endereco').value || null,
                    cidade: document.getElementById('cliente-cidade').value || null,
                    estado: document.getElementById('cliente-estado').value || null,
                    totalCompras: 0,
                    dataCadastro: state.clienteEditando ? undefined : dayjs().format()
                };
                
                // Validar dados
                if (!cliente.nome || !cliente.telefone) {
                    mostrarAlerta('Preencha pelo menos nome e telefone.', 'warning');
                    return;
                }
                
                // Salvar no banco de dados
                await db.clientes.setItem(cliente.id, cliente);
                
                // Fechar modal e atualizar lista
                fecharModal();
                carregarClientes();
                carregarClientesParaVenda();
                atualizarDashboard();
                
                mostrarAlerta(`Cliente "${cliente.nome}" salvo com sucesso!`, 'success');
                
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                mostrarAlerta('Erro ao salvar cliente. Tente novamente.', 'danger');
            }
        }
        
        // Excluir cliente
        async function excluirCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) {
                return;
            }
            
            try {
                const cliente = await db.clientes.getItem(id);
                if (!cliente) {
                    mostrarAlerta('Cliente não encontrado.', 'warning');
                    return;
                }
                
                // Verificar se o cliente está em alguma venda
                const vendas = await db.vendas.keys();
                let clienteEmVenda = false;
                
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda && venda.clienteId === id) {
                        clienteEmVenda = true;
                        break;
                    }
                }
                
                if (clienteEmVenda) {
                    mostrarAlerta('Este cliente não pode ser excluído porque está em vendas registradas.', 'warning');
                    return;
                }
                
                // Excluir cliente
                await db.clientes.removeItem(id);
                
                // Atualizar interface
                carregarClientes();
                carregarClientesParaVenda();
                atualizarDashboard();
                
                mostrarAlerta('Cliente excluído com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                mostrarAlerta('Erro ao excluir cliente. Tente novamente.', 'danger');
            }
        }
        
        // ==============================================
        // FUNÇÕES DO MÓDULO RELATÓRIOS
        // ==============================================
        
        // Gerar relatório
        async function gerarRelatorio() {
            try {
                const tipo = document.getElementById('tipo-relatorio').value;
                const dataInicio = document.getElementById('relatorio-data-inicio').value;
                const dataFim = document.getElementById('relatorio-data-fim').value;
                
                const container = document.getElementById('relatorio-container');
                container.innerHTML = '<div class="loader"></div>';
                
                // Aguardar um pouco para mostrar o loader
                await new Promise(resolve => setTimeout(resolve, 100));
                
                let html = '';
                
                switch (tipo) {
                    case 'vendas':
                        html = await gerarRelatorioVendas(dataInicio, dataFim);
                        break;
                    case 'produtos':
                        html = await gerarRelatorioProdutosMaisVendidos(dataInicio, dataFim);
                        break;
                    case 'estoque':
                        html = await gerarRelatorioEstoqueBaixo();
                        break;
                    case 'faturamento':
                        html = await gerarRelatorioFaturamentoMensal();
                        break;
                    default:
                        html = '<p class="text-center">Tipo de relatório não implementado.</p>';
                }
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                document.getElementById('relatorio-container').innerHTML = 
                    '<div class="alert alert-danger">Erro ao gerar relatório. Tente novamente.</div>';
            }
        }
        
        // Gerar relatório de vendas por período
        async function gerarRelatorioVendas(dataInicio, dataFim) {
            try {
                const vendas = await db.vendas.keys();
                const vendasArray = [];
                
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda) {
                        vendasArray.push(venda);
                    }
                }
                
                // Filtrar por data
                let vendasFiltradas = vendasArray;
                
                if (dataInicio) {
                    const inicio = dayjs(dataInicio).startOf('day');
                    vendasFiltradas = vendasFiltradas.filter(v => dayjs(v.data).isAfter(inicio) || dayjs(v.data).isSame(inicio));
                }
                
                if (dataFim) {
                    const fim = dayjs(dataFim).endOf('day');
                    vendasFiltradas = vendasFiltradas.filter(v => dayjs(v.data).isBefore(fim) || dayjs(v.data).isSame(fim));
                }
                
                // Ordenar por data
                vendasFiltradas.sort((a, b) => new Date(a.data) - new Date(b.data));
                
                // Calcular totais
                const totalVendas = vendasFiltradas.length;
                const totalFaturado = vendasFiltradas.reduce((total, v) => total + v.total, 0);
                const mediaVenda = totalVendas > 0 ? totalFaturado / totalVendas : 0;
                
                // Criar tabela
                let tabelaHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Resumo do Período</h3>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Total de Vendas</label>
                                <input type="text" value="${totalVendas}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Faturamento Total</label>
                                <input type="text" value="R$ ${totalFaturado.toFixed(2)}" readonly>
                            </div>
                            <div class="form-group">
                                <label>Ticket Médio</label>
                                <input type="text" value="R$ ${mediaVenda.toFixed(2)}" readonly>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3 class="card-title">Vendas Detalhadas</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Data/Hora</th>
                                        <th>Cliente</th>
                                        <th>Itens</th>
                                        <th>Total</th>
                                        <th>Pagamento</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                for (const venda of vendasFiltradas) {
                    const cliente = venda.clienteId ? await db.clientes.getItem(venda.clienteId) : null;
                    const qtdItens = venda.itens.reduce((total, item) => total + item.quantidade, 0);
                    
                    tabelaHTML += `
                        <tr>
                            <td>${venda.id}</td>
                            <td>${dayjs(venda.data).format('DD/MM/YYYY HH:mm')}</td>
                            <td>${cliente ? cliente.nome : 'Consumidor Final'}</td>
                            <td>${qtdItens}</td>
                            <td>R$ ${venda.total.toFixed(2)}</td>
                            <td>${venda.formaPagamento}</td>
                        </tr>
                    `;
                }
                
                if (vendasFiltradas.length === 0) {
                    tabelaHTML += `
                        <tr>
                            <td colspan="6" class="text-center">Nenhuma venda encontrada para o período.</td>
                        </tr>
                    `;
                }
                
                tabelaHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Adicionar gráfico
                const canvasHTML = `
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3 class="card-title">Vendas por Dia</h3>
                        </div>
                        <canvas id="chart-vendas" height="100"></canvas>
                    </div>
                `;
                
                // Criar gráfico após a tabela ser renderizada
                setTimeout(() => {
                    criarGraficoVendasPorDia(vendasFiltradas);
                }, 100);
                
                return canvasHTML + tabelaHTML;
                
            } catch (error) {
                console.error('Erro ao gerar relatório de vendas:', error);
                return '<div class="alert alert-danger">Erro ao gerar relatório de vendas.</div>';
            }
        }
        
        // Criar gráfico de vendas por dia
        function criarGraficoVendasPorDia(vendas) {
            try {
                // Agrupar vendas por dia
                const vendasPorDia = {};
                
                for (const venda of vendas) {
                    const data = dayjs(venda.data).format('DD/MM');
                    if (!vendasPorDia[data]) {
                        vendasPorDia[data] = 0;
                    }
                    vendasPorDia[data] += venda.total;
                }
                
                const dias = Object.keys(vendasPorDia);
                const valores = Object.values(vendasPorDia);
                
                // Criar gráfico
                const ctx = document.getElementById('chart-vendas');
                if (!ctx) return;
                
                // Destruir gráfico anterior se existir
                if (ctx.chart) {
                    ctx.chart.destroy();
                }
                
                ctx.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dias,
                        datasets: [{
                            label: 'Faturamento (R$)',
                            data: valores,
                            backgroundColor: 'rgba(52, 152, 219, 0.7)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao criar gráfico:', error);
            }
        }
        
        // Gerar relatório de produtos mais vendidos
        async function gerarRelatorioProdutosMaisVendidos(dataInicio, dataFim) {
            try {
                const vendas = await db.vendas.keys();
                const contagemProdutos = {};
                
                // Filtrar vendas por período
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda) {
                        // Verificar se a venda está no período
                        if (dataInicio) {
                            const inicio = dayjs(dataInicio).startOf('day');
                            if (dayjs(venda.data).isBefore(inicio)) {
                                continue;
                            }
                        }
                        
                        if (dataFim) {
                            const fim = dayjs(dataFim).endOf('day');
                            if (dayjs(venda.data).isAfter(fim)) {
                                continue;
                            }
                        }
                        
                        // Contar produtos
                        for (const item of venda.itens) {
                            if (!contagemProdutos[item.produtoId]) {
                                contagemProdutos[item.produtoId] = {
                                    quantidade: 0,
                                    total: 0,
                                    produto: null
                                };
                            }
                            contagemProdutos[item.produtoId].quantidade += item.quantidade;
                            contagemProdutos[item.produtoId].total += item.total;
                        }
                    }
                }
                
                // Buscar informações dos produtos
                for (const produtoId in contagemProdutos) {
                    const produto = await db.produtos.getItem(produtoId);
                    if (produto) {
                        contagemProdutos[produtoId].produto = produto;
                    }
                }
                
                // Converter para array e ordenar
                const produtosArray = Object.values(contagemProdutos)
                    .filter(item => item.produto)
                    .sort((a, b) => b.quantidade - a.quantidade);
                
                // Criar tabela
                let tabelaHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Produtos Mais Vendidos</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Posição</th>
                                        <th>Produto</th>
                                        <th>Categoria</th>
                                        <th>Quantidade Vendida</th>
                                        <th>Faturamento Gerado</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (produtosArray.length === 0) {
                    tabelaHTML += `
                        <tr>
                            <td colspan="5" class="text-center">Nenhum produto vendido no período.</td>
                        </tr>
                    `;
                } else {
                    produtosArray.forEach((item, index) => {
                        const produto = item.produto;
                        tabelaHTML += `
                            <tr>
                                <td>${index + 1}º</td>
                                <td>${produto.nome}</td>
                                <td>${produto.categoria}</td>
                                <td>${item.quantidade} ${produto.unidade}</td>
                                <td>R$ ${item.total.toFixed(2)}</td>
                            </tr>
                        `;
                    });
                }
                
                tabelaHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                return tabelaHTML;
                
            } catch (error) {
                console.error('Erro ao gerar relatório de produtos mais vendidos:', error);
                return '<div class="alert alert-danger">Erro ao gerar relatório de produtos mais vendidos.</div>';
            }
        }
        
        // Gerar relatório de estoque baixo
        async function gerarRelatorioEstoqueBaixo() {
            try {
                const produtos = await db.produtos.keys();
                const produtosBaixoEstoque = [];
                
                for (const key of produtos) {
                    const produto = await db.produtos.getItem(key);
                    if (produto && produto.estoque <= produto.estoqueMinimo) {
                        produtosBaixoEstoque.push(produto);
                    }
                }
                
                // Ordenar por quantidade (menor primeiro)
                produtosBaixoEstoque.sort((a, b) => a.estoque - b.estoque);
                
                // Criar tabela
                let tabelaHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Produtos com Estoque Baixo</h3>
                            <small>Total: ${produtosBaixoEstoque.length} produtos</small>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Código</th>
                                        <th>Produto</th>
                                        <th>Categoria</th>
                                        <th>Estoque Atual</th>
                                        <th>Estoque Mínimo</th>
                                        <th>Preço de Venda</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                if (produtosBaixoEstoque.length === 0) {
                    tabelaHTML += `
                        <tr>
                            <td colspan="7" class="text-center">Nenhum produto com estoque baixo.</td>
                        </tr>
                    `;
                } else {
                    for (const produto of produtosBaixoEstoque) {
                        const status = produto.estoque === 0 ? 
                            '<span class="text-danger">ESGOTADO</span>' : 
                            '<span class="text-warning">BAIXO</span>';
                        
                        tabelaHTML += `
                            <tr>
                                <td>${produto.codigo}</td>
                                <td>${produto.nome}</td>
                                <td>${produto.categoria}</td>
                                <td>${produto.estoque} ${produto.unidade}</td>
                                <td>${produto.estoqueMinimo} ${produto.unidade}</td>
                                <td>R$ ${produto.precoVenda.toFixed(2)}</td>
                                <td>${status}</td>
                            </tr>
                        `;
                    }
                }
                
                tabelaHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                return tabelaHTML;
                
            } catch (error) {
                console.error('Erro ao gerar relatório de estoque baixo:', error);
                return '<div class="alert alert-danger">Erro ao gerar relatório de estoque baixo.</div>';
            }
        }
        
        // Gerar relatório de faturamento mensal
        async function gerarRelatorioFaturamentoMensal() {
            try {
                const vendas = await db.vendas.keys();
                const faturamentoPorMes = {};
                
                // Obter vendas dos últimos 6 meses
                const meses = [];
                for (let i = 5; i >= 0; i--) {
                    const mes = dayjs().subtract(i, 'month');
                    const mesFormatado = mes.format('MM/YYYY');
                    meses.push(mesFormatado);
                    faturamentoPorMes[mesFormatado] = 0;
                }
                
                // Calcular faturamento por mês
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda) {
                        const mesVenda = dayjs(venda.data).format('MM/YYYY');
                        if (faturamentoPorMes.hasOwnProperty(mesVenda)) {
                            faturamentoPorMes[mesVenda] += venda.total;
                        }
                    }
                }
                
                // Criar gráfico
                const canvasHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Faturamento Mensal (Últimos 6 meses)</h3>
                        </div>
                        <canvas id="chart-faturamento" height="100"></canvas>
                    </div>
                `;
                
                // Criar tabela
                let tabelaHTML = `
                    <div class="card mt-20">
                        <div class="card-header">
                            <h3 class="card-title">Detalhamento por Mês</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Mês/Ano</th>
                                        <th>Faturamento</th>
                                    </tr>
                                </thead>
                                <tbody>
                `;
                
                for (const mes of meses) {
                    tabelaHTML += `
                        <tr>
                            <td>${mes}</td>
                            <td>R$ ${faturamentoPorMes[mes].toFixed(2)}</td>
                        </tr>
                    `;
                }
                
                tabelaHTML += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                
                // Criar gráfico após a tabela ser renderizada
                setTimeout(() => {
                    criarGraficoFaturamentoMensal(meses, faturamentoPorMes);
                }, 100);
                
                return canvasHTML + tabelaHTML;
                
            } catch (error) {
                console.error('Erro ao gerar relatório de faturamento mensal:', error);
                return '<div class="alert alert-danger">Erro ao gerar relatório de faturamento mensal.</div>';
            }
        }
        
        // Criar gráfico de faturamento mensal
        function criarGraficoFaturamentoMensal(meses, faturamentoPorMes) {
            try {
                const valores = meses.map(mes => faturamentoPorMes[mes]);
                
                // Criar gráfico
                const ctx = document.getElementById('chart-faturamento');
                if (!ctx) return;
                
                // Destruir gráfico anterior se existir
                if (ctx.chart) {
                    ctx.chart.destroy();
                }
                
                ctx.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: meses,
                        datasets: [{
                            label: 'Faturamento (R$)',
                            data: valores,
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            borderWidth: 2,
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value.toFixed(2);
                                    }
                                }
                            }
                        }
                    }
                });
                
            } catch (error) {
                console.error('Erro ao criar gráfico de faturamento:', error);
            }
        }
        
        // Imprimir relatório
        function imprimirRelatorio() {
            const conteudo = document.getElementById('relatorio-container').innerHTML;
            const janela = window.open('', '_blank');
            
            janela.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Relatório SisLoja</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        .card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; }
                        .card-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                        .text-center { text-align: center; }
                    </style>
                </head>
                <body>
                    <h1>Relatório SisLoja - ${dayjs().format('DD/MM/YYYY HH:mm')}</h1>
                    ${conteudo}
                </body>
                </html>
            `);
            
            janela.document.close();
            janela.print();
        }
        
        // ==============================================
        // FUNÇÕES DO MÓDULO CÓDIGOS DE BARRAS
        // ==============================================
        
        // Gerar código de barras
        function gerarCodigoBarras() {
            try {
                const tipo = document.getElementById('barcode-type').value;
                const valor = document.getElementById('barcode-value').value;
                const texto = document.getElementById('barcode-text').value;
                
                if (!valor) {
                    mostrarAlerta('Digite um valor para gerar o código de barras.', 'warning');
                    return;
                }
                
                // Gerar código
                const svg = document.getElementById('barcode');
                svg.innerHTML = '';
                
                JsBarcode(svg, valor, {
                    format: tipo,
                    width: 2,
                    height: 100,
                    displayValue: true
                });
                
                // Exibir texto se fornecido
                const textDisplay = document.getElementById('barcode-text-display');
                if (texto) {
                    textDisplay.textContent = texto;
                    textDisplay.classList.remove('hidden');
                } else {
                    textDisplay.classList.add('hidden');
                }
                
                mostrarAlerta('Código de barras gerado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao gerar código de barras:', error);
                mostrarAlerta('Erro ao gerar código de barras. Verifique o valor informado.', 'danger');
            }
        }
        
        // Validar código de barras EAN-13
        function validarCodigoBarras() {
            try {
                const codigo = document.getElementById('validar-barcode').value.trim();
                const resultado = document.getElementById('validacao-resultado');
                
                if (!codigo) {
                    resultado.innerHTML = '<div class="alert alert-warning">Digite um código para validar.</div>';
                    return;
                }
                
                // Verificar se é EAN-13 (13 dígitos)
                if (!/^\d{13}$/.test(codigo)) {
                    resultado.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Código inválido!</strong><br>
                            O código EAN-13 deve conter exatamente 13 dígitos.
                        </div>
                    `;
                    return;
                }
                
                // Calcular dígito verificador
                const baseCodigo = codigo.substring(0, 12);
                const digitoVerificador = calcularDigitoVerificadorEAN(baseCodigo);
                const digitoInformado = parseInt(codigo[12]);
                
                if (digitoVerificador === digitoInformado) {
                    resultado.innerHTML = `
                        <div class="alert alert-success">
                            <strong>Código válido!</strong><br>
                            Dígito verificador correto: ${digitoVerificador}
                        </div>
                    `;
                } else {
                    resultado.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Código inválido!</strong><br>
                            Dígito verificador esperado: ${digitoVerificador}<br>
                            Dígito verificador informado: ${digitoInformado}
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Erro ao validar código de barras:', error);
                document.getElementById('validacao-resultado').innerHTML = 
                    '<div class="alert alert-danger">Erro ao validar código de barras.</div>';
            }
        }
        
        // Imprimir código de barras
        function imprimirCodigoBarras() {
            const barcode = document.getElementById('barcode').innerHTML;
            const texto = document.getElementById('barcode-text-display').textContent;
            
            if (!barcode || barcode.trim() === '') {
                mostrarAlerta('Gere um código de barras primeiro.', 'warning');
                return;
            }
            
            const janela = window.open('', '_blank');
            
            janela.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Etiqueta de Código de Barras</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 0; 
                            padding: 10px;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            min-height: 100vh;
                        }
                        .barcode-container {
                            text-align: center;
                            border: 1px solid #000;
                            padding: 20px;
                            margin: 10px;
                        }
                        .texto {
                            margin-top: 10px;
                            font-size: 14px;
                            font-weight: bold;
                        }
                        @media print {
                            body { margin: 0; }
                            .barcode-container { border: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="barcode-container">
                        ${barcode}
                        ${texto ? `<div class="texto">${texto}</div>` : ''}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 100);
                        };
                    <\/script>
                </body>
                </html>
            `);
            
            janela.document.close();
        }
        
        // Salvar código de barras como imagem
        function salvarCodigoBarras() {
            const svg = document.getElementById('barcode');
            
            if (!svg || svg.innerHTML === '') {
                mostrarAlerta('Gere um código de barras primeiro.', 'warning');
                return;
            }
            
            try {
                // Converter SVG para imagem
                const serializer = new XMLSerializer();
                const source = serializer.serializeToString(svg);
                const blob = new Blob([source], { type: 'image/svg+xml' });
                const url = URL.createObjectURL(blob);
                
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = svg.clientWidth;
                    canvas.height = svg.clientHeight + 30; // Espaço para texto
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Fundo branco
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Desenhar código de barras
                    ctx.drawImage(img, 0, 0);
                    
                    // Adicionar texto se houver
                    const texto = document.getElementById('barcode-text-display').textContent;
                    if (texto) {
                        ctx.fillStyle = 'black';
                        ctx.font = '14px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(texto, canvas.width / 2, canvas.height - 10);
                    }
                    
                    // Converter para URL de dados
                    const dataURL = canvas.toDataURL('image/png');
                    
                    // Criar link para download
                    const a = document.createElement('a');
                    a.href = dataURL;
                    a.download = `codigo_barras_${dayjs().format('YYYYMMDD_HHmmss')}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    URL.revokeObjectURL(url);
                    
                    mostrarAlerta('Código de barras salvo como imagem!', 'success');
                };
                
                img.src = url;
                
            } catch (error) {
                console.error('Erro ao salvar código de barras:', error);
                mostrarAlerta('Erro ao salvar código de barras como imagem.', 'danger');
            }
        }
        
        // ==============================================
        // FUNÇÕES DO MÓDULO CONFIGURAÇÕES
        // ==============================================
        
        // Salvar configuração
        async function salvarConfiguracao() {
            try {
                state.config.nomeLoja = document.getElementById('nome-loja').value;
                state.config.estoqueMinimoAlerta = parseInt(document.getElementById('estoque-minimo-alerta').value);
                state.config.impostoPadrao = parseFloat(document.getElementById('imposto-padrao').value);
                
                await db.config.setItem('configuracoes', state.config);
                
                // Atualizar notificações
                atualizarNotificacoes();
                
                mostrarAlerta('Configurações salvas com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao salvar configurações:', error);
                mostrarAlerta('Erro ao salvar configurações.', 'danger');
            }
        }
        
        // Exportar todos os dados
        async function exportarTodosDados() {
            try {
                // Coletar todos os dados
                const dados = {
                    produtos: [],
                    clientes: [],
                    vendas: [],
                    configuracoes: state.config,
                    exportadoEm: dayjs().format()
                };
                
                // Produtos
                const produtos = await db.produtos.keys();
                for (const key of produtos) {
                    const produto = await db.produtos.getItem(key);
                    if (produto) {
                        dados.produtos.push(produto);
                    }
                }
                
                // Clientes
                const clientes = await db.clientes.keys();
                for (const key of clientes) {
                    const cliente = await db.clientes.getItem(key);
                    if (cliente) {
                        dados.clientes.push(cliente);
                    }
                }
                
                // Vendas
                const vendas = await db.vendas.keys();
                for (const key of vendas) {
                    const venda = await db.vendas.getItem(key);
                    if (venda) {
                        dados.vendas.push(venda);
                    }
                }
                
                // Criar arquivo JSON
                const dadosJSON = JSON.stringify(dados, null, 2);
                const blob = new Blob([dadosJSON], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_sisloja_${dayjs().format('YYYY-MM-DD_HH-mm')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                
                mostrarAlerta('Backup criado com sucesso!', 'success');
                
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                mostrarAlerta('Erro ao exportar dados. Tente novamente.', 'danger');
            }
        }
        
        // Importar dados
        async function importarDados(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!confirm('Importar dados substituirá todos os dados atuais. Tem certeza?')) {
                document.getElementById('importar-arquivo').value = '';
                return;
            }
            
            try {
                const reader = new FileReader();
                
                reader.onload = async (event) => {
                    try {
                        const dados = JSON.parse(event.target.result);
                        
                        // Limpar dados atuais
                        await db.produtos.clear();
                        await db.clientes.clear();
                        await db.vendas.clear();
                        
                        // Importar produtos
                        if (dados.produtos && Array.isArray(dados.produtos)) {
                            for (const produto of dados.produtos) {
                                await db.produtos.setItem(produto.id, produto);
                            }
                        }
                        
                        // Importar clientes
                        if (dados.clientes && Array.isArray(dados.clientes)) {
                            for (const cliente of dados.clientes) {
                                await db.clientes.setItem(cliente.id, cliente);
                            }
                        }
                        
                        // Importar vendas
                        if (dados.vendas && Array.isArray(dados.vendas)) {
                            for (const venda of dados.vendas) {
                                await db.vendas.setItem(venda.id, venda);
                            }
                        }
                        
                        // Importar configurações
                        if (dados.configuracoes) {
                            state.config = { ...state.config, ...dados.configuracoes };
                            await db.config.setItem('configuracoes', state.config);
                            aplicarConfiguracoes();
                        }
                        
                        // Limpar campo de arquivo
                        document.getElementById('importar-arquivo').value = '';
                        
                        // Atualizar interface
                        atualizarDashboard();
                        carregarProdutos();
                        carregarClientes();
                        carregarVendas();
                        atualizarNotificacoes();
                        
                        mostrarAlerta('Dados importados com sucesso!', 'success');
                        
                    } catch (parseError) {
                        console.error('Erro ao analisar arquivo:', parseError);
                        mostrarAlerta('Arquivo inválido. Certifique-se de que é um backup válido do SisLoja.', 'danger');
                    }
                };
                
                reader.onerror = () => {
                    mostrarAlerta('Erro ao ler arquivo. Tente novamente.', 'danger');
                };
                
                reader.readAsText(file);
                
            } catch (error) {
                console.error('Erro ao importar dados:', error);
                mostrarAlerta('Erro ao importar dados. Tente novamente.', 'danger');
            }
        }
        
        // Limpar todos os dados
        async function limparDados() {
            if (!confirm('ATENÇÃO: Esta ação irá remover TODOS os dados do sistema (produtos, clientes, vendas). É irreversível. Tem certeza?')) {
                return;
            }
            
            if (!confirm('CONFIRMAÇÃO FINAL: Você realmente deseja apagar todos os dados?')) {
                return;
            }
            
            try {
                await db.produtos.clear();
                await db.clientes.clear();
                await db.vendas.clear();
                
                // Recriar dados de exemplo
                await criarProdutosExemplo();
                await criarClientesExemplo();
                
                // Atualizar interface
                atualizarDashboard();
                carregarProdutos();
                carregarClientes();
                carregarVendas();
                atualizarNotificacoes();
                
                mostrarAlerta('Todos os dados foram limpos e dados de exemplo foram recriados.', 'success');
                
            } catch (error) {
                console.error('Erro ao limpar dados:', error);
                mostrarAlerta('Erro ao limpar dados. Tente novamente.', 'danger');
            }
        }
        
        // ==============================================
        // FUNÇÕES UTILITÁRIAS
        // ==============================================
        
        // Atualizar dashboard (chamada externa)
        window.atualizarDashboard = function() {
            carregarDashboard();
        };
        
        // Mostrar alerta
        function mostrarAlerta(mensagem, tipo = 'info') {
            // Remover alertas anteriores
            const alertasAnteriores = document.querySelectorAll('.alert-flutuante');
            alertasAnteriores.forEach(alerta => alerta.remove());
            
            // Criar alerta
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo} alert-flutuante`;
            alerta.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                min-width: 300px;
                max-width: 500px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            alerta.innerHTML = `
                <div>${mensagem}</div>
                <button class="close-alert" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            document.body.appendChild(alerta);
            
            // Remover automaticamente após 5 segundos
            setTimeout(() => {
                if (alerta.parentElement) {
                    alerta.remove();
                }
            }, 5000);
        }
        
        // Fechar modal
        function fecharModal() {
            document.getElementById('produto-modal').classList.add('hidden');
            document.getElementById('cliente-modal').classList.add('hidden');
            state.produtoEditando = null;
            state.clienteEditando = null;
        }
        
        // Imprimir recibo de venda
        async function imprimirRecibo(vendaId) {
            try {
                const venda = await db.vendas.getItem(vendaId);
                if (!venda) {
                    mostrarAlerta('Venda não encontrada para impressão.', 'warning');
                    return;
                }
                
                const cliente = venda.clienteId ? await db.clientes.getItem(venda.clienteId) : null;
                
                // Preencher dados do recibo
                document.getElementById('recibo-nome-loja').textContent = state.config.nomeLoja;
                document.getElementById('recibo-id').textContent = venda.id;
                document.getElementById('recibo-data').textContent = dayjs(venda.data).format('DD/MM/YYYY HH:mm:ss');
                document.getElementById('recibo-cliente').textContent = cliente ? cliente.nome : 'Consumidor Final';
                document.getElementById('recibo-vendedor').textContent = 'Administrador';
                document.getElementById('recibo-subtotal').textContent = venda.subtotal.toFixed(2);
                document.getElementById('recibo-desconto').textContent = venda.desconto.toFixed(2);
                document.getElementById('recibo-acrescimo').textContent = venda.acrescimo.toFixed(2);
                document.getElementById('recibo-total').textContent = venda.total.toFixed(2);
                document.getElementById('recibo-pagamento').textContent = venda.formaPagamento;
                document.getElementById('recibo-recebido').textContent = venda.valorRecebido.toFixed(2);
                document.getElementById('recibo-troco').textContent = venda.troco.toFixed(2);
                
                // Preencher itens
                const tbody = document.querySelector('#recibo-itens tbody');
                tbody.innerHTML = '';
                
                for (const item of venda.itens) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.nome}</td>
                        <td>${item.quantidade}</td>
                        <td>R$ ${item.precoUnitario.toFixed(2)}</td>
                        <td>R$ ${item.total.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                }
                
                // Abrir janela de impressão
                const reciboConteudo = document.getElementById('recibo').outerHTML;
                const janela = window.open('', '_blank');
                
                janela.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Recibo de Venda - ${venda.id}</title>
                        <style>
                            body { 
                                font-family: 'Courier New', monospace; 
                                margin: 0; 
                                padding: 10px;
                                font-size: 14px;
                                width: 80mm;
                            }
                            .text-center { text-align: center; }
                            .text-right { text-align: right; }
                            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                            th, td { padding: 5px; border-bottom: 1px dashed #ccc; }
                            hr { border: none; border-top: 1px dashed #000; margin: 10px 0; }
                            @media print {
                                body { margin: 0; padding: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        ${reciboConteudo}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 100);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                
                janela.document.close();
                
            } catch (error) {
                console.error('Erro ao imprimir recibo:', error);
                mostrarAlerta('Erro ao imprimir recibo.', 'danger');
            }
        }
        
        // Adicionar funções ao escopo global para uso em eventos HTML
        window.alterarQuantidade = alterarQuantidade;
        window.removerItemCarrinho = removerItemCarrinho;
        window.imprimirRecibo = imprimirRecibo;
        
        // Inicializar a aplicação
        console.log('SisLoja inicializado com sucesso!');
        
    </script>
</body>
</html>
